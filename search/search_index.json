{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Welcome!","text":"<p>Thank you for taking an interest in the Open Client Registry (OpenCR)! This is a community project and meant for others to adopt to their use cases as they wish.</p> <p>Tip</p> <p>Regardless if you're just curious, an implementer, or a developer, please read the this page first and then the User Manual. We've kept them short.</p> <p>There are four manuals in the OpenCR technical documentation. Choose the one based on your needs:</p> <ul> <li>User: Start here then move on. This covers the basics, use cases, how matching works, and the user interface.</li> <li>Implementer: This manual covers some of the areas important to deploying OpenCR.</li> <li>Developer: This manual covers details for building new features and customizing OpenCR.</li> <li>Sysadmin: This manual shows how to install OpenCR on servers and how to configure it.</li> </ul>"},{"location":"#what-is-opencr","title":"What is OpenCR?","text":"<p>OpenCR is an open source and standards-based client registry. A client registry facilitates the exchange of patient information between disparate systems. A client registry holds patient identifers and may include patient demographic information. It is a necessary tool for public health to help manage patients, monitor outcomes, and conduct case-based surveillance.</p> <p>A client registry sits within a health information exchange (HIE). An HIE is used to safely and effectively exchange information. A critical component of an HIE are registries, such as those to manage a shared, canonical facility list, practitioners, and patients. </p>"},{"location":"#what-does-opencr-do","title":"What does OpenCR do?","text":"<p>OpenCR is offers the ability to:</p> <ul> <li>Assign and look-up unique identifiers,</li> <li>Allow connections from diverse point of service (POS) systems, such as lab systems and electronic medical record (EMR) systems, that can submit messages in FHIR,</li> <li>Configure decision rules around patient matching.</li> </ul> <p>Caution</p> <p>This implementation does not allow point-of-service systems to get patient demographic information stored in the Client Registry. This is also not a Shared Health Record, nor does it contain patient clinical data.</p>"},{"location":"#use-cases","title":"Use Cases","text":"<p>The Client Registry is one component in a more complex HIS architecture needed to accomplish important use cases, such as:</p> <ul> <li> <p>Deduplicating patients: Sometimes patients have multiple diagnostic results stored within a POS. The Client Registry will link patients based on configurable decision rules so multiple test results for the same patient can be found. </p> </li> <li> <p>Tracking patients lost to clinical care: EMRs are often not interoperable with one another, resulting in difficulty tracking patients as they move between facilities to seek care. A Client Registry will help data managers to track patients, decreasing instances of duplicate and incomplete records, patients LTFU, and sub-optimal care. </p> </li> </ul> <p>Caution</p> <p>The Client Registry is not deduplicating or even touching patient clinical and demographic records within point-of-service systems. Instead, it provides a way to enable use cases like deduplication - which must be an external process. </p>"},{"location":"#about","title":"About","text":"<p>OpenCR was developed by IntraHealth International with support from PEPFAR through the USAID MEASURE Evaluation Project. Technical direction was provided by CDC. </p>"},{"location":"admin/ansible/","title":"Ansible","text":"<p>This documents how to use Ansible playbooks to set up a production-like server installation. It differs from a production installation in that certificates must not be self-signed in a production environment.</p> <p>These steps are for installing on a server OS directly and require experience with remote configuration and Linux administration.</p>"},{"location":"admin/ansible/#preparation","title":"Preparation","text":"<p>You must have a local VM or remote server. See <code>/packaging/vagrant/centos</code> for a Vagrant VM (CentOS 7) script for working example of creating a local VM.</p> <p>Clone the main repository. The Ansible playbooks and templates are in that folder.</p> <pre><code>git clone https://github.com/intrahealth/client-registry.git\ncd client-registry/packaging/ansible\n</code></pre>"},{"location":"admin/ansible/#ssh","title":"SSH","text":"<p>Create a VM. Make sure to include a public ssh key for the user who will install prerequisites. Your SSH public key should be in <code>.ssh/authorized_keys</code> on the remote host, ie:</p> <pre><code>cat ~/.ssh/id_rsa.pub | ssh user@remotehost 'cat &gt;&gt; .ssh/authorized_keys'\n</code></pre>"},{"location":"admin/ansible/#specify-hosts","title":"Specify hosts","text":"<p>Hosts can be specified in inventory files or on the command line. To use Ansible with an inventory file, you must create a file or edit the one in the repository. There are yaml and ini formats supported.</p> <p>A <code>hosts</code> file that has an entry for one server would be:</p> <pre><code>[servers]\n172.16.174.137\n</code></pre> <p>Note that <code>[servers]</code> is not necessary, it is way to tag groups of servers. The file may simply contain an IP address or domain.</p> <p>To use the hosts file:</p> <pre><code>ansible-playbook -i hosts someplaybook.yaml\n</code></pre> <p>Alternately, hosts may be specified on the command line (the comma is necessary even if there is only one host):</p> <pre><code>ansible-playbook -i 172.16.168.158, someplaybook.yaml\n</code></pre>"},{"location":"admin/ansible/#opencr-user-optional","title":"opencr user (optional)","text":"<p>A example playbook is provided to show how to create a <code>opencr</code> user with sudo permissions using Ansible to be used with the host. </p> <p>Create the <code>opencr</code> user and gives it sudo access:</p> <pre><code>ansible-playbook -i hosts user.yaml\n</code></pre>"},{"location":"admin/ansible/#installation","title":"Installation","text":"<pre><code>ansible-playbook -i hosts prep_centos.yaml -e user=opencr\nansible-playbook -i hosts elasticsearch.yaml -e user=opencr\nansible-playbook -i hosts tomcat.yaml -e user=opencr\nansible-playbook -i hosts postgres.yaml -e user=opencr -e pgpass=hapi\nansible-playbook -i hosts hapi.yaml -e user=opencr\nansible-playbook -i hosts opencr.yaml -e user=opencr\n</code></pre> <p>An optional step but recommeded is to check the logs for services running after installation:</p> <pre><code>ansible-playbook -i hosts troubleshoot.yaml -e user=opencr\n</code></pre> <p>OpenCR is now running. It will only allow requests from localhost (from the same server it is installed on).</p> <p>Visit: https://ipaddress:3000/crux</p> <p>HTTPS must be used.</p> <p>Warning</p> <p>If not running localhost, follow the next steps to create self-signed server and client certs, and copy them onto the server using an Ansible script below.</p>"},{"location":"admin/ansible/#certificates-required-if-not-using-localhost","title":"Certificates (Required if not using localhost)","text":"<p>Note</p> <p>These steps are automated in the certs.sh script, but please read through the steps to understand what is happening. To use: <code>bash certs.sh &lt;ip address or domain&gt;</code> Then run the ansible script to replace it on the server: <code>ansible-playbook -i hosts servercerts.yaml -e user=opencr</code></p> <p>Two certificate pairs are required, one pair for the server and one for the client generated from the server's. The existing self-signed server certs use localhost as the CN. This can be seen with the following for any cert:</p> <pre><code>$ openssl x509 -in ../../server/certificates/server_cert.pem -text\n...\n        Subject: CN = localhost, O = Client Registry\n...\n</code></pre> <p>This means that new server and client certificates need to be generated with the IP address or domain for clients to access the client registry if it is not running on localhost.</p> <p>Caution</p> <p>Self-signed certificates must only be created for testing and demonstrations and in non-production settings.</p> <p>Make a note of your IP or domain for which you need to create a server cert. Run the following to create a new server cert/key pair. It will ask for a pass phrase (which is required in production) but -nodes option squashes that. This will create two files, server_key.pem and server_cert.pem. We can inspect the certificate to verify it has the IP address in the subject.</p> <pre><code># confirm ip being used\ncat hosts\nopenssl req -x509 -newkey rsa:4096 -keyout server_key.pem -out server_cert.pem -days 365 -subj \"/CN=172.16.168.172\" -nodes\n# confirm new CN\nopenssl x509 -in server_cert.pem -text\n</code></pre> <p>Now it is necessary to create new a new client cert based on the server cert. A key is first created, then the certificate, and they are packaged together in a p12 file.</p> <pre><code>openssl req -newkey rsa:4096 -keyout ansible_key.pem -out ansible_csr.pem -nodes -subj \"/CN=ansible\"\nopenssl x509 -req -in ansible_csr.pem -CA server_cert.pem -CAkey server_key.pem -out ansible_cert.pem -set_serial 01 -days 36500\n# requires specifying an export key\nopenssl pkcs12 -export -in ansible_cert.pem -inkey ansible_key.pem -out ansible.p12\n</code></pre> <p>The client certs can be placed in the existing folder for client certs for convenience.</p> <pre><code># add client certs\ncp ansible_key.pem ../../server/sampleclientcertificates/\ncp ansible_csr.pem ../../server/sampleclientcertificates/\ncp ansible_cert.pem ../../server/sampleclientcertificates/\ncp ansible.p12 ../../server/sampleclientcertificates/\n</code></pre> <p>Server certs may also be copied into ../../certificates/ for convenience but this will overwrite the copies and break localhost if the repo is used to upload code to GitHub.</p> <p>Warning</p> <p>To complete the process, server certs need to be placed into the server. This will be done using an Ansible script below.</p> <p>Copy the server certs to the server and restart opencr service to use them.</p> <pre><code>ansible-playbook -i hosts servercerts.yaml -e user=opencr\n</code></pre> <p>Test (for servers not localhost):</p> <pre><code># this assumes the server cert and client cert are in this (/packaging/ansible) directory\n# replace the path to your copy of the repo\n# replace the ip address of the server\ncurl --cert ansible.p12 --cert-type p12 --cacert server_cert.pem -d @/Users/richard/src/github.com/intrahealth/client-registry/DemoData/patient1_openmrs.json -H \"Content-Type: application/json\" -XPOST https://172.16.168.172:3000/Patient\n</code></pre>"},{"location":"admin/ansible/#add-additional-user-public-keys","title":"Add additional user public keys","text":"<p>As necessary, add additional ssh keys to the user <code>opencr</code>. (Ensure that the user's public key is available on github, ie. https://github.com/citizenrich.keys):</p> <pre><code>ansible-playbook -i hosts keys.yaml\n</code></pre>"},{"location":"admin/architecture/","title":"Architecture","text":"<p>OpenCR is not one application, instead it's a set of applications that work together in the Open Health Information Exchange (OpenHIE) architecture to serve point-of-service systems, like EMRs, insurance mechanisms, and labs.</p> <p>Note</p> <p>This is not an OpenHIE product. The OpenHIE community of practice does not produce software products. Rather OpenHIE produces an architecture specification and is composed of a large, global community of practice around standards-based health information exchanges, particularly in low resource settings. Please join us!</p> <p>The OpenCR architecture includes:</p> <ul> <li>The OpenCR Service: The API for managing queries, routing traffic to the components, and overall entrypoint. It is written in Node JS.</li> <li>The HAPI FHIR Server: HAPI is the reference FHIR server in Java and scalable into production environments.</li> <li>Either OpenSearch or ElasticSearch: Both OpenSearch and Elasticsearch are powerful search engines that are highly performant. One of them must be installed, not both, however we do recommend OpenSearch to be used only because of the license restrictions with ElasticSearch.</li> <li>An optional UI to view and break matches between records, and view matching histories (audit events).</li> <li>The Open Health Information Mediator (OpenHIM) (Optional): The OpenHIM is the entrypoint for POS systems, and includes authentication (are you who you say you are?), authorization (what roles do you have permission to fulfill?), and auditing of all transactions. OpenHIM is optional but the administrator must manage users and node access in some manner if not with OpenHIM.</li> </ul> <p></p>"},{"location":"admin/backup/","title":"Backup and Recovery","text":""},{"location":"admin/backup/#backup","title":"Backup","text":"<p>The primary datastore is the database of HAPI FHIR Server. This means that while an ES cluster should be backed-up, the ES index can be rebuilt from HAPI. </p> <ul> <li> <p>Either Postgres or MySQL are recommended to be used with HAPI FHIR Server. In production, database should be cloned or replicas created and cloned and those backups tested.</p> </li> <li> <p>Depending on the database, there are separate processes to backup data itself in a database and information about users, groups and other metadata. </p> </li> <li> <p>It is recommended to create a backup and recovery policy (data and metadata, timeframes, full-versus-incremental, from replicas or not).</p> </li> </ul>"},{"location":"admin/backup/#recovery-policy","title":"Recovery Policy","text":"<ul> <li> <p>Backups should be tested in a non-production system for their ability to be used for recovery. There are existing online resources on how to test backups. </p> </li> <li> <p>A backup policy should include scheduled recovery tests to ensure that backups are suitable.</p> </li> </ul>"},{"location":"admin/configuration/","title":"Configuration","text":"<p>Often there are many records of the same person but in many people in different systems. The purpose of the Client Registry is to link patients in different systems, but not to transfer any data, neither clinical records nor demographic data.</p> <p>Caution</p> <p>The Client Registry does not store clinical information. Having the Client Registry enables the ability to create a Shared Health Record in the future.</p> <p>Note</p> <p>OpenSearch and ElasticSearch uses exactly the same technology and have almost the same configuration, i.e ports etc. The configuration file of OpenCR uses parameter elasticsearch to refer to either ElasticSearch or OpenSearch.</p> <p>The Client Registry stores the patient demographic data submitted to it in queries. The Client Registry stores demographic data at least in the HAPI FHIR Server, which can have any database backend an implementer chooses to use.</p> <p>OpenSearch/ElasticSearch (ES) is a required search engine for matching, and may requires configuration.</p> <p>JSON files are used to configure the system. Later iterations will support environment variables and a graphical interface. See https://github.com/openhie/client-registry/tree/master/server/config for example configuration files discussed here.</p>"},{"location":"admin/configuration/#deciding-between-a-standalone-or-mediator-configuration","title":"Deciding Between a Standalone or Mediator Configuration","text":"<p>A central application is the Client Registry Service, as distinct from the larger Client Registry platform. There are two options for running the application, as an OpenHIM mediator or as standalone application.</p> <p>Choose running the app standalone when:</p> <ul> <li>For testing, demonstration, or development environments.</li> <li>There are few clients that will connect to managing client authentication and roles will not be a burden.</li> <li>There is no need for an additional layer of auditing.</li> </ul> <p>Choose running the app as a mediator when:</p> <ul> <li>For production. The central application should be run as a mediator registered in OpenHIM.</li> <li>There are many clients that will need to connect.</li> <li>There is a need to audit transactions.</li> <li>There is an existing health information exchange layer or OpenHIM.</li> <li>One advantage of using the OpenHIM interface is the ability to change settings like the FHIR server.</li> </ul>"},{"location":"admin/configuration/#security-and-privacy","title":"Security and Privacy","text":"<p>Many configuration options relate to privacy and security. These steps are critical to address. See the security page</p> <p>Whether in standalone or as a mediator, the Client Registry must interact only with known, trusted clients with TLS certificates. Clients must be registered and certificates assigned to them.</p> <p>In standalone mode, the server runs TLS by default, and requires signed certificates. Client certificate needs can be turned off in OpenHIM when running as a mediator and this feature must be regularly audited to ensure security.</p>"},{"location":"admin/configuration/#connecting-services","title":"Connecting Services","text":"<p>The default ports are as follows:</p> <ul> <li>3000: Client Registry Service</li> <li>9200: OpenSearch/ElasticSearch (closed to external)</li> <li>8080: HAPI FHIR Server (closed to external)</li> </ul> <p>In <code>server/config/config_development_template.json</code> there is a template for configuration.</p> <p>Link to file</p> <p>Contents of <code>server/config/config_development_template.json</code></p> <pre><code>{\n  \"app\": {\n    \"port\": 3000,\n    \"installed\": false\n  },\n  \"mediator\": {\n    \"api\": {\n      \"username\": \"root@openhim.org\",\n      \"password\": \"openhim-password\",\n      \"apiURL\": \"https://localhost:8080\",\n      \"trustSelfSigned\": true,\n      \"urn\": \"\"\n    },\n    \"register\": false\n  },\n  \"fhirServer\": {\n    \"baseURL\": \"http://localhost:8080/clientregistry/fhir\",\n    \"username\": \"hapi\",\n    \"password\": \"hapi\"\n  },\n  \"elastic\": {\n    \"server\": \"http://localhost:9200\",\n    \"username\": \"\",\n    \"password\": \"\",\n    \"max_compilations_rate\": \"10000/1m\",\n    \"index\": \"patients\"\n  },\n  \"structureDefinition\": {\n    \"reportRelationship\": \"patientreport\"\n  },\n  \"matching\": {\n    \"tool\": \"mediator\"\n  },\n  \"systems\": {\n    \"openmrs\": {\n      \"uri\": \"http://clientregistry.org/openmrs\"\n    },\n    \"dhis2\": {\n      \"uri\": \"http://clientregistry.org/dhis2\"\n    },\n    \"lims\": {\n      \"uri\": \"http://clientregistry.org/lims\"\n    },\n    \"brokenMatch\": {\n      \"uri\": \"http://ihris.org/CR/brokenMatch\"\n    }\n  },\n  \"sync\": {\n    \"lastFHIR2ESSync\": \"1970-01-01T00:00:06\"\n  },\n  \"__comments\": {\n    \"matching.tool\": \"this tells if the app should use mediator algorithms or elasticsearch algorithms for matching, two options mediator and elasticsearch\"\n  }\n}\n</code></pre>"},{"location":"admin/configuration/#general-app-configuration","title":"General App Configuration","text":"<p><code>app.port</code> is the port the application will run on.</p> <p><code>app.installed</code> can be left to True. This tells the Client Registry Service to load structure definitions into HAPI FHIR Server, otherwise it will not.</p>"},{"location":"admin/configuration/#mediator-app-configuration","title":"Mediator App Configuration","text":"<p><code>mediator.register</code> to true if the application will run as a mediator. Or, to false if the app will run as standalone.</p> <p><code>mediator.api.xx</code> settings are only if running as a mediator.</p> <p><code>mediator.api.username | password</code> must be different. The existing settings are defaults and must be changed when configuring the OpenHIM.</p> <p><code>mediator.api.trustSelfSigned</code> should be set to false in production or any sensitive environment. True is only for demonstrations.</p>"},{"location":"admin/configuration/#fhir-server","title":"FHIR Server","text":"<p>The currently supported FHIR version is R4.</p> <p><code>fhirServer.baseURL</code> is the default. Note that it may change depending on the way HAPI is installed. It may, for example, default to a baseURL of http://localhost:8080/baseR4/.</p> <p><code>fhirServer.username | password</code> must be changed from defaults in HAPI.</p>"},{"location":"admin/configuration/#configure-with-environment-variables","title":"Configure with Environment variables","text":"<p>In the scenario where only a few fields require changing it could be useful to configure these fields with Environment variables. Any value within the openCR config file object can be manually configured via enviroment variable.</p> <p>OpenHIM Mediator config cannot be configured in this manner</p> <p>OpenCR uses the <code>nconf</code> library to store app config. nconf stores the config files in memory and environemnt variables take precedence. See the config object below:</p> <pre><code>{\n  \"app\": {\n    \"port\": 3000\n  }\n  ,\n  ...\n}\n</code></pre> <p>To configure the port field tfrom 300 to 3003 the syntax would be: <code>app:port=3003</code>. However, the colon syntax does not work well in many instances. To handle this we have configured nconf to accept __ as a replacement for the colon separator. What this means is that to configure the port field you would use the following, <code>app__port=3003</code>. This syntax works for deeper nested config as well. For example, let's configure password in the config object below:</p> <pre><code>{\n  ...\n  \"mediator\": {\n    \"api\": {\n      \"password\": \"openhim-password\"\n    }\n  }\n}\n</code></pre> <p>The syntax to change the field from openhim-password to newPassword would be <code>mediator__api__password=newPassword</code></p>"},{"location":"admin/configuration/#opensearchelasticsearch-configuration","title":"OpenSearch/ElasticSearch Configuration","text":"<p>For OpenSearch/ElasticSearch, the relationship between patient resources in FHIR and what fields are synchronized in OpenSearch/ElasticSearch must be explicitly defined. This is termed the Report Relationship mapping. One must define what resource to be used (patient) and what fields need to be available in OpenSearch/ElasticSearch. After this, the Client Registry reads these fields, and populates OpenSearch/ElasticSearch with the information.</p> <p>In <code>resources/Relationships/PatientRelationship.json</code> there is a template for configuration.</p> <p>Link to file</p> <p>Contents of <code>resources/Relationships/PatientRelationship.json</code></p> <pre><code>{\n  \"resourceType\": \"Basic\",\n  \"id\": \"patientreport\",\n  \"meta\": {\n    \"versionId\": \"1\",\n    \"lastUpdated\": \"2019-07-30T07:34:24.098+00:00\",\n    \"profile\": [\"http://ihris.org/fhir/StructureDefinition/iHRISRelationship\"]\n  },\n  \"extension\": [\n    {\n      \"url\": \"http://ihris.org/fhir/StructureDefinition/iHRISReportDetails\",\n      \"extension\": [\n        {\n          \"url\": \"label\",\n          \"valueString\": \"Patient Report\"\n        },\n        {\n          \"url\": \"name\",\n          \"valueString\": \"patients\"\n        },\n        {\n          \"url\": \"http://ihris.org/fhir/StructureDefinition/iHRISReportElement\",\n          \"extension\": [\n            {\n              \"url\": \"label\",\n              \"valueString\": \"gender\"\n            },\n            {\n              \"url\": \"name\",\n              \"valueString\": \"gender\"\n            }\n          ]\n        },\n        {\n          \"url\": \"http://ihris.org/fhir/StructureDefinition/iHRISReportElement\",\n          \"extension\": [\n            {\n              \"url\": \"label\",\n              \"valueString\": \"birthDate\"\n            },\n            {\n              \"url\": \"name\",\n              \"valueString\": \"birthDate\"\n            }\n          ]\n        },\n        {\n          \"url\": \"http://ihris.org/fhir/StructureDefinition/iHRISReportElement\",\n          \"extension\": [\n            {\n              \"url\": \"label\",\n              \"valueString\": \"given\"\n            },\n            {\n              \"url\": \"name\",\n              \"valueString\": \"name.where(use='official').last().given\"\n            }\n          ]\n        },\n        {\n          \"url\": \"http://ihris.org/fhir/StructureDefinition/iHRISReportElement\",\n          \"extension\": [\n            {\n              \"url\": \"label\",\n              \"valueString\": \"family\"\n            },\n            {\n              \"url\": \"name\",\n              \"valueString\": \"name.where(use='official').last().family\"\n            }\n          ]\n        },\n        {\n          \"url\": \"http://ihris.org/fhir/StructureDefinition/iHRISReportElement\",\n          \"extension\": [\n            {\n              \"url\": \"label\",\n              \"valueString\": \"fullname\"\n            },\n            {\n              \"url\": \"name\",\n              \"valueString\": \"name.where(use='official').last().text\"\n            }\n          ]\n        },\n        {\n          \"url\": \"http://ihris.org/fhir/StructureDefinition/iHRISReportElement\",\n          \"extension\": [\n            {\n              \"url\": \"label\",\n              \"valueString\": \"phone\"\n            },\n            {\n              \"url\": \"name\",\n              \"valueString\": \"telecom.where(system='phone').value\"\n            }\n          ]\n        }\n      ]\n    }\n  ],\n  \"code\": {\n    \"coding\": [\n      {\n        \"system\": \"http://ihris.org/fhir/ValueSet/ihris-resource\",\n        \"code\": \"iHRISRelationship\"\n      }\n    ],\n    \"text\": \"iHRISRelationship\"\n  },\n  \"subject\": {\n    \"reference\": \"StructureDefinition/Patient\"\n  }\n}\n</code></pre>"},{"location":"admin/configuration/#openhim-mediator-json-configuration","title":"OpenHIM Mediator JSON Configuration","text":"<p>If using OpenHIM, it must be configured for proper clients and roles to accept and forward requests from the Client Registry. An example export of a working JSON configuration that can be imported for development purposes is available.</p> <p>Link to file</p> <p>Contents of <code>server/config/mediator.json</code></p> <pre><code>{\n  \"urn\": \"urn:uuid:4bc42b2f-b5a8-473d-8207-5dd5c61f0c4a\",\n  \"version\": \"0.0.1\",\n  \"name\": \"Client Registry\",\n  \"description\": \"Uganda Client Registry\",\n  \"config\": {\n    \"fhirServer\": {\n      \"username\": \"hapi\",\n      \"password\": \"hapi\",\n      \"baseURL\": \"http://localhost:8080/hapi/fhir\"\n    },\n    \"elastic\": {\n      \"server\": \"http://localhost:9200\",\n      \"username\": \"\",\n      \"password\": \"\",\n      \"max_compilations_rate\": \"10000/1m\",\n      \"index\": \"patients\"\n    },\n    \"matching\": {\n      \"tool\": \"elasticsearch\"\n    }\n  },\n  \"configDefs\": [\n    {\n      \"param\": \"fhirServer\",\n      \"displayName\": \"FHIR Server\",\n      \"description\": \"FHIR Server Configuration Details\",\n      \"type\": \"struct\",\n      \"template\": [\n        {\n          \"type\": \"string\",\n          \"description\": \"The base URL (e.g. http://localhost:8080/hapi/fhir)\",\n          \"displayName\": \"Base URL\",\n          \"param\": \"baseURL\"\n        },\n        {\n          \"type\": \"string\",\n          \"description\": \"Username required to access FHIR server\",\n          \"displayName\": \"Username\",\n          \"param\": \"username\"\n        },\n        {\n          \"type\": \"password\",\n          \"description\": \"Password required to access FHIR server\",\n          \"displayName\": \"Password\",\n          \"param\": \"password\"\n        }\n      ],\n      \"values\": []\n    },\n    {\n      \"param\": \"elastic\",\n      \"displayName\": \"Elasticsearch Server\",\n      \"description\": \"Elasticsearch Server Configuration Details\",\n      \"type\": \"struct\",\n      \"template\": [\n        {\n          \"type\": \"string\",\n          \"description\": \"The base URL (e.g. http://localhost:9200)\",\n          \"displayName\": \"Base URL\",\n          \"param\": \"server\"\n        },\n        {\n          \"type\": \"string\",\n          \"description\": \"Username required to access elasticsearch server\",\n          \"displayName\": \"Username\",\n          \"param\": \"username\"\n        },\n        {\n          \"type\": \"password\",\n          \"description\": \"Password required to access elasticsearch server\",\n          \"displayName\": \"Password\",\n          \"param\": \"password\"\n        },\n        {\n          \"type\": \"string\",\n          \"description\": \"Number of requests to compile per minute\",\n          \"displayName\": \"Maximum Compilations Rate\",\n          \"param\": \"max_compilations_rate\"\n        },\n        {\n          \"type\": \"string\",\n          \"description\": \"index to use for data storage\",\n          \"displayName\": \"Index Name\",\n          \"param\": \"index\"\n        }\n      ],\n      \"values\": []\n    },\n    {\n      \"param\": \"matching\",\n      \"displayName\": \"FHIR Server\",\n      \"description\": \"FHIR Server Configuration Details\",\n      \"type\": \"struct\",\n      \"template\": [\n        {\n          \"type\": \"option\",\n          \"values\": [\"mediator\", \"elasticsearch\"],\n          \"description\": \"Tool to Use for Matching\",\n          \"displayName\": \"Tool to Use for Matching\",\n          \"param\": \"tool\"\n        }\n      ],\n      \"values\": []\n    }\n  ],\n  \"defaultChannelConfig\": [\n    {\n      \"requestBody\": true,\n      \"responseBody\": true,\n      \"name\": \"Add Patients\",\n      \"description\": \"Post a new patient into the client registry\",\n      \"urlPattern\": \"/addPatient\",\n      \"matchContentRegex\": null,\n      \"matchContentXpath\": null,\n      \"matchContentValue\": null,\n      \"matchContentJson\": null,\n      \"pollingSchedule\": null,\n      \"tcpHost\": null,\n      \"tcpPort\": null,\n      \"autoRetryPeriodMinutes\": 60,\n      \"autoRetryEnabled\": false,\n      \"rewriteUrlsConfig\": [],\n      \"addAutoRewriteRules\": true,\n      \"rewriteUrls\": false,\n      \"status\": \"enabled\",\n      \"alerts\": [],\n      \"txRerunAcl\": [],\n      \"txViewFullAcl\": [],\n      \"txViewAcl\": [],\n      \"properties\": [],\n      \"matchContentTypes\": [],\n      \"routes\": [\n        {\n          \"name\": \"Add Patient\",\n          \"secured\": false,\n          \"host\": \"localhost\",\n          \"port\": 3000,\n          \"path\": \"/addPatient\",\n          \"pathTransform\": \"\",\n          \"primary\": true,\n          \"username\": \"\",\n          \"password\": \"\",\n          \"forwardAuthHeader\": false,\n          \"status\": \"enabled\",\n          \"type\": \"http\"\n        }\n      ],\n      \"authType\": \"public\",\n      \"whitelist\": [],\n      \"allow\": [],\n      \"type\": \"http\",\n      \"methods\": [\"POST\"]\n    }\n  ],\n  \"endpoints\": [\n    {\n      \"name\": \"Activate Client Registry\",\n      \"host\": \"localhost\",\n      \"path\": \"/addPatient\",\n      \"port\": 3000,\n      \"primary\": true,\n      \"forwardAuthHeader\": false,\n      \"status\": \"enabled\",\n      \"type\": \"http\"\n    }\n  ],\n  \"_uptime\": 2201.945,\n  \"_lastHeartbeat\": \"2017-12-15T03:47:03.365Z\",\n  \"_configModifiedTS\": \"2017-12-15T02:52:49.054Z\"\n}\n</code></pre>"},{"location":"admin/decision_rules/","title":"Decision Rules","text":""},{"location":"admin/decision_rules/#overview","title":"Overview","text":"<p>Demographic data from submitting systems is stored in HAPI FHIR. It is also recommended that the demographic data that is primarily stored in HAPI FHIR be indexed into Elasticsearch.</p> <p>For match processing, there are two options. One is run in mediator-only mode, which is highly flexible and supports a handful of algorithms that can be chained together. Additional algorithms can be added as needed. </p> <p>The second is to use ES. ES is very fast and supports compound queries but currently only supports Levenshtein distance.  When using ES, every request to the FHIR Server is cached in ES.</p> <p>(One additional caveat for Levenshtein distance is that the mediator-only matching can support edit distances exceeding two, while ES edit distance cannot exceed two.)</p> <p>Every client wishing to use the Client Registry must be authenticated and authorized. See the configuration page for more information. </p>"},{"location":"admin/decision_rules/#how-to-set-decision-rules","title":"How to Set Decision Rules","text":"<p>Decision rules determine how matches are made among records, for example, by using a certain algorithm on one field and a different algorithm on another. </p> <p>Let's use the below example:</p> <p><code>rules.givenName</code> is used as one rule on the field givenName.</p> <p><code>rules.givenName.algorithm</code> defines an algorithm, in this instance Jaro-Winkler, and an threshold for that algorithm unique to it.</p> <p><code>rules.givenName.path</code> is a required FHIRpath for the fields, a standard way to define how to traverse a FHIR resource. In future, a GUI may be used for defining the FHIRpath.</p> <p>By default, all of the rules are chained together in a logical AND statement. In ES the search queries are assembled into compound queries.</p> <p>Link to file</p> <p>Contents of <code>server/config/decision_rules.json</code></p> <pre><code>{\n  \"__comments\": {\n    \"path\": \"Its a fhir path, for syntax refer to https://www.hl7.org/fhir/fhirpath.html\",\n    \"type\": \"String, Date, Number or Boolean\",\n    \"threshold\": {\n      \"levenshtein\": \"Lower the number, the closer the match, 0 being exact match\",\n      \"jaro-winkler\": \"number between 0 and 1, where 0 for no match and 1 for exact match\"\n    }\n  },\n  \"rules\": {\n    \"givenName\": {\n      \"algorithm\": \"jaro-winkler\",\n      \"threshold\": 0.89,\n      \"path\": \"name.where(use='official').last().given\",\n      \"type\": \"string\",\n      \"systems\": [\"system1\", \"system2\", \"system3\"]\n    },\n    \"familyName\": {\n      \"algorithm\": \"damerau-levenshtein\",\n      \"threshold\": 3,\n      \"path\": \"name.where(use='official').last().family\",\n      \"type\": \"String\"\n    },\n    \"gender\": {\n      \"algorithm\": \"exact\",\n      \"path\": \"gender\",\n      \"type\": \"String\"\n    }\n  }\n}\n</code></pre>"},{"location":"admin/docker/","title":"Local Installation using Docker","text":"<p>Time to complete</p> <p>10 Minutes</p> <p>Warning</p> <p>This guide is for demonstrations or tests only, not for servers or production environments.</p> <p>The easiest way to get started with OpenCR is to use Docker to launch ElasticSearch and HAPI FHIR Server and run the OpenCR Service directly. By running the OpenCR Service directly, it is easy to revise and reload decision rules.</p> <p>These instructions have been tested on Linux and macOS.</p> <p>Note</p> <p>This installation method requires some familiarity with the command line.</p>"},{"location":"admin/docker/#prerequisites","title":"Prerequisites","text":"<ul> <li>Any modern PC capable of running Docker for Desktop.</li> <li>macOS: 2010 and newer Macs. macOS 10.13 or later (Sierra, Mojava, Catalina).</li> <li>Windows 10 64-bit (Education, Pro, or Enterprise). Note that you must have Hyper-V and Containers Windows enabled and these require administrator privileges.</li> <li>8GB RAM on the computer is recommended. ElasticSearch and HAPI FHIR Server will use up to 1GB of RAM. OpenCR Service will use less than 200MB RAM.</li> <li>Docker for Desktop</li> <li>Node 10 which includes npm.</li> <li>git</li> </ul>"},{"location":"admin/docker/#instructions","title":"Instructions","text":"<ul> <li>Clone the repository and change directory into the root folder.</li> </ul> <pre><code>https://github.com/intrahealth/client-registry.git\ncd client-registry\n</code></pre> <ul> <li>Ensure that Docker is installed and running.</li> </ul> <pre><code>docker --version\n</code></pre>"},{"location":"admin/docker/#docker-hapi-fhir-and-es-with-node-opencr","title":"Docker HAPI-FHIR and ES with node OpenCR","text":"<p>Start ElasticSearch and HAPI FHIR Server using Docker.</p> <p>Warning</p> <p>You cannot use the existing hosted ElasticSearch image because OpenCR requires two plugins to be installed. The docker-compose file provided uses the Dockerfile-es which builds an ES image with the plugins.</p> <pre><code>docker-compose up fhir es\n</code></pre> <ul> <li>Then install the requirements for the OpenCR Service.</li> </ul> <pre><code>cd server\nnpm install\n</code></pre> <ul> <li>Copy a configuration for Docker for the OpenCR Service to use.</li> </ul> <pre><code>cp config/config_docker_template.json config/config_docker.json\n</code></pre> <ul> <li>Run the server using the docker config for NODE_ENV.</li> </ul> <pre><code># from client-registry/server\nsudo NODE_ENV=docker node lib/app.js\n</code></pre> <p><code>sudo</code> is needed as OpenCR requires access to /var/log for logging. This requirement may be changed in the future.</p> <ul> <li>Visit the UI at: https://localhost:3000/crux</li> <li>Default username: root@intrahealth.org</li> <li>Default password: intrahealth</li> </ul>"},{"location":"admin/docker/#docker-compose-fhir-es-and-opencr","title":"Docker-Compose FHIR, ES, and OpenCR","text":"<pre><code>docker-compose -f docker-compose.cicd.yml up -d\n</code></pre> <p>The flag <code>-d</code> runs the processes in the background.</p> <ul> <li>Visit the UI at: https://localhost:3000/crux</li> <li>Default username: root@intrahealth.org</li> <li>Default password: intrahealth</li> </ul>"},{"location":"admin/docker/#change-the-opencr-config","title":"Change the OpenCR Config","text":"<p>If you want to add dockerised OpenCR to a system with different docker dependency names, you can add new config files with the following script changes.</p> <p>In this scenario, we are going to change the HAPI-FHIR container name to <code>test-fhir</code>.</p> <p>To start, open the <code>/server/config/config_cicd_template.json</code> file in a text editor and in the <code>\"fhirServer\":</code> config section make the following change:</p> <pre><code>...\n\"fhirServer\": {\n  \"baseURL\": \"http://test-fhir:8080/fhir\",\n  \"username\": \"hapi\",\n  \"password\": \"hapi\"\n},\n...\n</code></pre> <p>With that config in place we need to volume in this new config file into our <code>docker-compose.cicd.yml</code> file. Open this file in a text editor. We need three changes, first change the depends_on value from fhir to <code>test-fhir</code>. Then, add a new environment variable <code>HAPI_FHIR_URL</code> with the value http://test-fhir:8080/fhir/metadata. This url will be used to check the HAPI FHIR instance is running. Finally, add the volumes config to opencr. Your <code>opencr</code> config section should resemble this:</p> <pre><code>  opencr:\n    container_name: opencr\n    image: intrahealth/opencr\n    ports:\n      - \"3000:3000\"\n    depends_on:\n      - test-fhir\n      - es\n    restart: always\n    environment:\n      - NODE_ENV=cicd\n      - HAPI_FHIR_URL=http://test-fhir:8080/fhir/metadata\n    volumes:\n      - ./server/config/config_cicd_template.json:/src/server/config/config_cicd.json\n</code></pre> <p>Now we can start the system with the following:</p> <pre><code>docker-compose -f docker-compose.cicd.yml up -d\n</code></pre> <p>The flag <code>-d</code> runs the processes in the background.</p> <ul> <li>Visit the UI at: https://localhost:3000/crux</li> <li>Default username: root@intrahealth.org</li> <li>Default password: intrahealth</li> </ul>"},{"location":"admin/docker/#view-status-details-of-containers","title":"View status details of containers","text":"<p>To see the container statuses run the following command:</p> <pre><code>docker ps -a\n</code></pre> <p>The flag <code>-a</code> will include containers that are not running (i.e. from errors or a manual container stop)</p>"},{"location":"admin/docker/#view-system-logs","title":"View system logs","text":"<p>To see the logs of a component run the following command:</p> <pre><code>docker logs -f &lt;component&gt;\n</code></pre> <p>Components are: <code>opencr</code>, <code>es</code>, and <code>fhir</code></p>"},{"location":"admin/docker/#spin-down-test-instance","title":"Spin down test instance","text":"<p>To remove OpenCR and its dependencies, run the following:</p> <pre><code>docker-compose -f docker-compose.cicd.yml down\n</code></pre>"},{"location":"admin/installation/","title":"Local Installation","text":"<p>Time to complete</p> <p>60 Minutes</p> <p>Warning</p> <p>This guide is for demonstrations or tests only, not for production environments.</p> <p>Note</p> <p>This installation method requires familiarity with the command line.</p>"},{"location":"admin/installation/#prerequisites","title":"Prerequisites","text":"<ul> <li>CPU/RAM: Modern CPUs with 8GB RAM.</li> <li>Java version 8 (1.8). Oracle-licensed Java (requires sign-in) and AdoptOpenJDK (not sign-in required) have been tested.</li> <li>Node 10 which includes npm.</li> <li>git</li> </ul>"},{"location":"admin/installation/#hapi-fhir-server-cli","title":"HAPI FHIR Server CLI","text":"<p>For non-production environments, the HAPI maintainers provide a simple CLI-based tool to run it.</p> <p>The only required dependency is Java &gt;= 8 (1.8).</p> <p>See HAPI FHIR CLI for instructions for the OS of choice.</p> <p>The Client Registry requires FHIR version R4 and HAPI must be started for this version. To run HAPI:</p> <pre><code>hapi-fhir-cli run-server -v r4\n</code></pre> <p>The HAPI Web Testing UI is available at http://localhost:8080/ The Web Testing UI should be disabled for production. It allows the viewing of any resource on the server.</p> <p>The FHIR Base URL is at http://localhost:8080/baseR4/</p> <p>Visit http://localhost:8080/ to ensure HAPI is up and running or</p> <pre><code>curl -X GET \"localhost:8080/baseR4/Patient?\"\n</code></pre>"},{"location":"admin/installation/#indexing","title":"Indexing","text":"<p>openCR supports both elasticsearch and opensearch, you are free to use either of them but we do recommend opensearch because of elasticsearch license restrictions. Follow instructions below to either install opensearch or elasticsearch</p>"},{"location":"admin/installation/#opensearch","title":"OpenSearch","text":"<p>Install and start opensearch for the intended OS. See the install instructions here</p> <p>The required version is &gt;=2.1.</p> <p>The phonetic analysis package must be installed. For example:</p> <pre><code>/usr/share/opensearch/bin/opensearch-plugin install analysis-phonetic\n</code></pre> <p>The string similarity plugin must be installed. See: https://github.com/DigitalSQR/record-linkage/releases</p> <p>Once installed and started, ensure that opensearch is up and running:</p> <pre><code>curl -X GET \"localhost:9200/_cat/health?v&amp;pretty\"\n</code></pre> <p>Status should be yellow for a single-node cluster.</p>"},{"location":"admin/installation/#elasticsearch","title":"ElasticSearch","text":"<p>Install and start ES for the intended OS. See the ES install instructions</p> <p>The required version is &gt;=7.6.</p> <p>The phonetic analysis package must be installed. For example:</p> <pre><code>/usr/share/elasticsearch/bin/elasticsearch-plugin install analysis-phonetic\n</code></pre> <p>The string similarity plugin must be installed. See: https://github.com/intrahealth/similarity-scoring</p> <p>Once installed and started, ensure that ES is up and running:</p> <pre><code>curl -X GET \"localhost:9200/_cat/health?v&amp;pretty\"\n</code></pre> <p>Status should be yellow for a single-node cluster.</p>"},{"location":"admin/installation/#opencr-service-and-ui","title":"OpenCR Service and UI","text":"<p>Clone the repository into a directory of choice.</p> <pre><code>git clone https://github.com/intrahealth/client-registry.git\n</code></pre> <p>Enter the server directory, install node packages.</p> <pre><code>cd client-registry/server\nnpm install\n</code></pre> <p>Copy and edit the configuration file to your liking.</p> <pre><code>cp config/config_development_template.json config/config_development.json\n# edit the servers...\n</code></pre> <p>The minimum changes to start a running standalone system are:</p> <ul> <li>Change <code>fhirServer.baseURL</code> to \"http://localhost:8080/baseR4/\"</li> </ul> <p>Run the server from inside client-registry/server:</p> <pre><code># from client-registry/server\nsudo NODE_ENV=development node lib/app.js\n</code></pre> <ul> <li>Visit the UI at: https://localhost:3000/crux</li> <li>Default username: root@intrahealth.org</li> <li>Default password: intrahealth</li> </ul> <p>OpenCR may require access to /var/log for logging. This requirement may be changed in the future.</p> <p>Congratulations! Now it's time to run a query.</p>"},{"location":"admin/installation_full/","title":"Server Installation","text":"<p>Caution</p> <p>Installing and maintaining a production installation is not trivial. This installation method requires strong familiarity with the command line and expertise administering Linux environments.</p> <p>The core production stack consists of four components:</p> <ul> <li>OpenCR Service: This includes primary API for fielding requests, and the record viewing and matching breaking UI.</li> <li>HAPI FHIR Server + Database: HAPI FHIR Server is the reference implementation of FHIR in Java. It requries a database backend (e.g. Postgres or MySQL).</li> </ul> <p>Either</p> <ul> <li>OpenSearch: Version &gt;=2.1.0 supported and the analysis-phonetic plugin is required.</li> </ul> <p>OR</p> <ul> <li>ElasticSearch: Version &gt;=7.5 supported and the analysis-phonetic plugin is required.</li> </ul> <p>Optional components:</p> <ul> <li>OpenHIM core and OpenHIM admin console. Requires MongoDB. OpenHIM is an authentication, authorization, and auditing layer. While OpenHIM is optional, nodes and users must be managed in some application if not OpenHIM. Nodes must have certificates issued to query OpenCR and they must be rotated out over time. The OpenCR Service can manage simply installations but using an enterprise secrets management tool is recommended.</li> </ul>"},{"location":"admin/installation_full/#prerequisites","title":"Prerequisites","text":"<p>Linux is the expected operating system for production.</p> <p>It is critical that systems administrators note the version compatibilities outlined below. This guide does not cover most aspects of enterprise systems administration, rather it attempts to cover the OpenCR platform. If there are key areas missing, please open an issue on GitHub.</p> <ul> <li>If entities outside of your LAN are connecting to OpenCR, you will need a public-facing domain name. A domain is necessary for a certificate which is required for any queries.</li> <li>See Security</li> </ul>"},{"location":"admin/installation_full/#hapi-fhir-server-and-postgres","title":"HAPI FHIR Server and Postgres","text":"<p>HAPI FHIR must use a database backend in production. HAPI FHIR stores the patient demographic data from queries. If the data is lost, then OpenCR data is unrecoverable.</p> <ul> <li>Follow the JPA Server information and instructions for how to customize the hapi.properties file and build the server using maven.</li> <li>The ES integration is separate from HAPI FHIR Server, so there is not need to use it as an indexer. ES only works with an old version of ES.</li> <li>Install and configure the preferred database. Postgres has been tested by the maintainers but any database should work that HAPI supports. Change default passwords on the database.</li> <li>Database replication should be encrypted.</li> <li>Confirm that HAPI accepts requests.</li> <li>The web interface for HAPI should be disabled for privacy reasons.</li> </ul> <p>Caution</p> <p>In production, Postgres should run on multiple nodes with replication. This is to ensure high availability and backups of the data.</p>"},{"location":"admin/installation_full/#opensearch","title":"OpenSearch","text":"<ul> <li>Follow the instructions for installation</li> <li>Systemd is the preferred system and service manager. There are commands to initiate systemd and journalctl.</li> <li>The phonetic analysis package must be installed.</li> </ul> <pre><code>/usr/share/elasticsearch/bin/elasticsearch-plugin install analysis-phonetic\n</code></pre> <ul> <li>The string similarity plugin must be installed. See: https://github.com/DigitalSQR/record-linkage/releases</li> </ul>"},{"location":"admin/installation_full/#elasticsearch","title":"ElasticSearch","text":"<ul> <li>Follow the instructions for installation</li> <li>Systemd is the preferred system and service manager. There are commands to initiate systemd and journalctl.</li> <li>The phonetic analysis package must be installed.</li> </ul> <pre><code>/usr/share/elasticsearch/bin/elasticsearch-plugin install analysis-phonetic\n</code></pre> <ul> <li>The string similarity plugin must be installed. See: https://github.com/intrahealth/similarity-scoring</li> </ul> <p>Caution</p> <p>ES is not production-ready when run as one single node. It is recommended to run ES on several nodes. Those nodes can also run followers of Postgres.</p>"},{"location":"admin/installation_full/#opencr-service-and-ui","title":"OpenCR Service and UI","text":"<p>Clone the repository into a directory of choice.</p> <pre><code>git clone https://github.com/intrahealth/client-registry.git\n</code></pre> <p>Enter the server directory, install node packages.</p> <pre><code>cd client-registry/server\nnpm install\n</code></pre> <p>Copy and edit the configuration file to your liking.</p> <pre><code>cp config/config_development_template.json config/config_development.json\n# edit the servers...\n</code></pre> <p>The minimum changes to start a running standalone system are:</p> <ul> <li>Change <code>fhirServer.baseURL</code> to \"http://localhost:8080/baseR4/\"</li> </ul> <p>Run the server from inside client-registry/server:</p> <pre><code>node lib/app.js\n</code></pre>"},{"location":"admin/installation_full/#openhim-optional","title":"OpenHIM (Optional)","text":"<p>OpenHIM supports the last 2 versions of NodeJS LTS and requires MongoDB.</p> <ul> <li>Follow the instructions to install OpenHIM core and admin console. The maintainers use the NPM PPA installation method.</li> <li>Note the important step to obtain a certificate immediately after installation. The configuration should be that any client must have a certificate and the server has a certificate (mutual TLS).</li> <li>Follow the instructions including console configuration.</li> <li>Note the important step to change the console password. It is also recommended that the console only be accessible on a local subnet and not to the WAN.</li> <li>The config mediator.register must be set to true for the OpenCR Service to use OpenHIM.</li> </ul>"},{"location":"admin/internals/","title":"Internals","text":""},{"location":"admin/internals/#elasticsearch","title":"ElasticSearch","text":"<p>ES is a web service around the Apache Software Foundation-supported Lucene search engine. ES provides a JSON-based REST API, cluster management, and other value-add on top of Lucene. Many of the features discussed below are actually in Lucene, and are not specific to ES, although these docs refer to ES as including Lucene features. This can be confusing. ES means ES which includes Lucene.</p>"},{"location":"admin/internals/#mapping","title":"Mapping","text":"<p>Data fields to be indexed in ES require that they first be mapped. The CR mediator takes a mapping config file and generates the mapping based on it. Then, records are submitted to and indexed by ES. Indexes are created separated into segments. Segments can be on one system or across server nodes in cluster. When searches happen, the segments are searched in parallel, and then the results merged. </p> <p>For more information, see: Elasticsearch from the bottom up (EuroPython 2014 - Start at 18:28 unless you want to get deep into Lucene.): https://www.youtube.com/watch?v=PpX7J-G2PEo</p>"},{"location":"admin/internals/#es-filters-versus-queries","title":"ES Filters versus Queries","text":"<p>An important distinction is between filters and queries in ES. For CR purposes, filters can be used for blocking. Queries result in a score that is assigned to the result based on how well it matches the query. For more, eee: https://logz.io/blog/elasticsearch-queries/ Note that filters are cached, and thus faster. Also, query clauses can be used as either a filter or a query. Since filters are boolean (true/false), they are not scored.</p> <p>There are queries of diverse types, including Boolean, compound (chaining queries together), fuzzy matching, and other types. Queries result in a score that is assigned to the result based on how well it matches the query. With regard to risk for the Uganda use case, we have included blocking (filters) to meet the use requirements and the required query types.</p> <p>For more, see ElasticSearch Queries And the ES Query Domain Specific Language (DSL)</p>"},{"location":"admin/loadjs/","title":"Load Demo Data (JavaScript)","text":"<p>Demonstration data is provided in the /tests directory in the code repository. </p>"},{"location":"admin/loadjs/#install-the-node-packages","title":"Install the Node Packages","text":"<pre><code>cd tests\nnpm install\n</code></pre>"},{"location":"admin/loadjs/#configure-the-script","title":"Configure the Script","text":"<p>The /tests/uploadCSV.js script is used to upload the CSV data in the /tests directory.</p> <p>If using OpenHIM, then change the auth options and the IP address/hostname in /tests/uploadCSV</p> <pre><code># make a copy to modify\ncp uploadCSV.js uploadCSV_mychanges.js\n</code></pre> <p>The defaults are:</p> <pre><code>const options = {\nurl: 'http://localhost:5001/Patient',\nauth,\njson: entry.resource,\n};\n</code></pre> <p>Edit uploadCSV_mychanges.js. If not running OpenHIM then change: * remove <code>auth</code> and change it to <code>agentOptions</code> * Change the IP address/hostname as required, for example for Docker: 'https://localhost:3000/Patient'.</p> <p>After the edits, the code block looks like this:</p> <pre><code>const options = {\nurl: 'https://localhost:3000/Patient',\nagentOptions,\njson: entry.resource,\n};\n</code></pre> <p>Notice the https as without OpenHIM the OpenCR Service encrypts the connections using TLS instead of OpenHIM doing so.</p>"},{"location":"admin/loadjs/#running-the-script","title":"Running the Script","text":"<p>While in the /tests directory, ensure that OpenCR is running and run the script, with the required argument of the CSV:</p> <pre><code>sudo node uploadCSV_mychanges.js uganda_data_v21_20201501.csv\n</code></pre> <p>Caution</p> <p>The script may take several hours to process all of the records.</p>"},{"location":"admin/method/","title":"Choosing a Method","text":"<p>Select an installation method based on your requirements.</p> <p>Hint</p> <p>If you've used Docker before, it's the fastest way to evaluate OpenCR.</p> <p>Local installation (Docker): </p> <ul> <li>Skills required: git, Docker, some command line familiarity</li> <li>OS: macOS, Windows, Linux. </li> <li>Usage: Demos, training, evaluation, research.</li> </ul> <p>Local installation (Direct): </p> <ul> <li>Skills required: git, Docker, some command line familiarity</li> <li>OS: macOS, Windows, Linux. </li> <li>Usage: Software development, demos, training, evaluation, research.</li> </ul> <p>Server installation: </p> <ul> <li>Skills required: Command line and Linux expertise.</li> <li>OS: Linux. </li> <li>Usage: Production, research.</li> </ul>"},{"location":"admin/proficiencies/","title":"Proficiencies","text":""},{"location":"admin/proficiencies/#linux-systems-administration","title":"Linux Systems Administration","text":"<p>OpenCR is not one application, it's several and is expected to be run on Linux. Persons installing and managing OpenCR require advanced expertise with Linux. Here are the major topics where knowledge is required:</p> <ul> <li>Linux users and groups: This includes understanding and restricting <code>sudo</code> access.</li> <li>Networking: Limiting the public and LAN exposure of services. For instance, HAPI FHIR Server and OpenSearch/ElasticSearch should only be exposed to localhost while the UI may be exposed to a LAN subnet, if at all.</li> <li>Databases: HAPI FHIR Server requires a database backend. For demos, it can be used with an existing temporary datastore, Derby, but this is not appropriate for maintaining data in production. In production, databases should be backed up and those backups tested as suitable artifacts for recovery.</li> <li>Process management: systemd and the systemctl series of commands are recommended for managing the process lifecycle, including restarting services and logging their status.</li> <li>Logging: Suitable logging practice requires safely logging the minimum data required to understand performance and uptime.</li> <li>Auditing: The OpenCR software stack should be regularly audited. The security section discusses the range of issues to address.</li> </ul>"},{"location":"admin/proficiencies/#software","title":"Software","text":"<p>For installing and managing an existing OpenCR installation, there are a handful of commands that can be learned.</p> <ul> <li> <p>Java: HAPI FHIR Server and OpenSearch/ElasticSearch are written in Java. Java applications are generally built with frameworks for common design patterns and often built using Gradle or Maven.</p> </li> <li> <p>JavaScript and Node: The OpenCR Service is written in Node, a popular JavaScript framework for building RESTful applications. Node applications are packaged around the Node Package Manager.</p> </li> <li> <p>Postgres/MySQL: Either Postgres or MySQL are recommended to be used with HAPI FHIR Server. Administrators should become familiar with backup and recovery procedures.</p> </li> </ul>"},{"location":"admin/queries/","title":"Example API Query (cURL)","text":""},{"location":"admin/queries/#certificates-mandatory","title":"Certificates (Mandatory)","text":"<p>A system querying the Client Registry needs a server-issued certificate or it will not be authorized to use the service.</p> <p>The way that this works is that a server creates a certificate for a client. The certificate is signed by the server issuing it. The querying system then uses that certificate that has been issued to them in their requests. The server's public key is used by the querying system to verify that the certificate being sent is how the server verifies that the certificate was created by them.</p> <p>There is a set of generated certificates for testing and demonstrations. They are not appropriate for production.</p>"},{"location":"admin/queries/#a-simple-cli-query","title":"A Simple CLI Query","text":"<p>From inside the <code>/client-registry/server</code> directory, send a cURL query using the provided example JSON file:</p> <pre><code>curl --cert sampleclientcertificates/openmrs.p12 --cert-type p12 --cacert certificates/server_cert.pem -d @../DemoData/patient1_openmrs.json -H \"Content-Type: application/json\" -XPOST https://localhost:3000/fhir/Patient\n</code></pre> <p>Should result in a successful result in stdout:</p> <pre><code>info: Received a request to add new patient {\"timestamp\":\"2020-01-28 14:29:20\"}\ninfo: Searching to check if the patient exists {\"timestamp\":\"2020-01-28 14:29:20\"}\ninfo: Getting http://localhost:8080/baseR4/Patient?identifier=431287 from server {\"timestamp\":\"2020-01-28 14:29:20\"}\ninfo: Patient [{\"system\":\"http://clientregistry.org/openmrs\",\"value\":\"431287\"},{\"system\":\"http://system1.org\",\"value\":\"12349\",\"period\":{\"start\":\"2001-05-06\"},\"assigner\":{\"display\":\"test Org\"}}] doesnt exist, adding to the database {\"timestamp\":\"2020-01-28 14:29:20\"}\n</code></pre>"},{"location":"admin/requirements/","title":"System Requirements","text":""},{"location":"admin/requirements/#it-resource-planning","title":"IT Resource Planning","text":"<p>Benchmarking will be completed in future phases to make recommendations for medium to heavy workloads. The below resource suggestions should be revised based on benchmarking for the particular context into which OpenCR is being deployed.</p>"},{"location":"admin/requirements/#servers","title":"Servers","text":"<p>For an MVP in a production environment where potential data loss is acceptable, a single large server can be used. ES has high memory requirements. </p>"},{"location":"admin/requirements/#cpu","title":"CPU","text":"<ul> <li>2-8 cores available for the OpenCR platform apps.</li> </ul>"},{"location":"admin/requirements/#memory","title":"Memory","text":"<p>Memory usage depends on the number of records and the performance required. At minimum: 32GB with 24GB free for OpenCR is recommended for light loads if using one VM.</p> <ul> <li>16GB minimum for ElasticSearch with 32GB preferred or 64GB for high volume: Follow the guidelines provided by the maintainers here. </li> <li>8GB for OpenHIM, mediator, Postgres, and HAPI FHIR Server.</li> </ul>"},{"location":"admin/requirements/#disk-space","title":"Disk Space","text":"<p>This depends heavily on the workload. Expect 200GB at minimum per node.</p>"},{"location":"admin/security/","title":"Security","text":"<p>Warning</p> <p>It is difficult (and irresponsible) to try to explain all of the best practices in computer security. This page focuses on how security is addressed in the Open Client Registry. The information may be incomplete. Where there is more clarity or information needed, please provide feedback in an issue on GitHub so that it can be added.</p> <p>This page addresses several security areas, including hardening, user authentication, node authentication, auditing, and non-production (demos, tests) configurations.</p> <p>For links to information on server resource planning see the requirements page.</p>"},{"location":"admin/security/#hardening","title":"Hardening","text":"<p>Warning</p> <p>Server and network hardening and production best practices are out of scope. This document only attempts to capture aspects relevant to the Client Registry.</p>"},{"location":"admin/security/#general-server-network-and-service-hardening","title":"General Server, Network, and Service Hardening","text":"<p>Hardening and production best practices include:</p> <ul> <li>Removing unnecessary services, software, network protocols</li> <li>Backup and recovery</li> <li>Patches</li> <li>Vulnerability scanning</li> <li>Limiting remote administration</li> <li>Managing open internal and external ports</li> <li>Auditing, logging software</li> </ul> <p>See, for example, the Guide to General Server Security: Recommendations of the National Institute of Standards and Technology by Karen Scarfone, Wayne Jansen, Miles Tracy, July 2008, (NIST Special Publication 800-123).</p>"},{"location":"admin/security/#opencr-platform-hardening","title":"OpenCR Platform Hardening","text":"<p>In addition to the above general hardening practices that should be followed, some additional areas are important for the Client Registry.</p> <ul> <li>The OpenCR UI should only be available on a local subnet, and further restricted with user and node authentication so that it is not exposed on the WAN.</li> <li>Close external ports: Ports for Client Registry services should be locked down to localhost. The only external port required is for TLS with point-of-service systems that make queries to the Client Registry Service. This includes ES and HAPI FHIR. Those services can serve localhost only and effectively. </li> <li>TLS for cluster (interservice) communication: Where Postgres and ES must communicate with other nodes TLS can be configured for ES for internode communication and Postgres for replication.</li> <li>Disable HAPI Web Testing: The HAPI FHIR Server Web Testing UI should be disabled. This tool allows the viewing of demographic records on the server. It is not a tool suitable for production, or if it is used, then it is restricted to a local subnet and further restricted with user and node authentication.</li> <li>Double-check for default passwords: Ensure no default passwords are in use for OpenHIM core and console, HAPI FHIR Server, ES, Postgres, and other services.</li> </ul>"},{"location":"admin/security/#authentication-authorization-and-auditing","title":"Authentication, Authorization, and Auditing","text":""},{"location":"admin/security/#user-authentication","title":"User Authentication","text":"<ul> <li>Point-of-service systems should possess an appropriate identity provider solution built-in or externally. This also means following best practices for user authentication. </li> <li>The Client Registry Service and admin interface are the only direct access to demographic data systems that should require user authentication. As this Client Registry is meant for further customization during deployment, JWT and other user authentication solutions are not provided out-of-the-box but can be added.</li> <li>It is intended to support user-requested user authentication solutions as use cases are further identified.</li> </ul>"},{"location":"admin/security/#node-authentication","title":"Node Authentication","text":"<ul> <li>OpenCR follows best practices outlined in the ITI-19 standard for node authentication. </li> <li>Only secure nodes -- one with the ability to authenticate itself to other nodes and transmit data securely -- should be allowed to communicate with the Client Registry.</li> <li>Systems administrators should ensure that all clients must be registered and certificates assigned to them. In production, OpenCR may act as an OpenHIM mediator which provides an extra layer of security. Clients may be registered in OpenHIM.</li> </ul>"},{"location":"admin/security/#audit-events","title":"Audit Events","text":"<ul> <li>All transactions (including queries) are stored in audit events. These events are stored in the HAPI FHIR Server and viewable in the OpenCR UI. </li> <li>Being able to view audit events helps administrators run the system and tune queries,</li> <li>But, audit events must also be secured as they contain all information about queries. This means locking down the OpenCR by subnet, node, and user authentication.</li> </ul>"},{"location":"admin/security/#atna-logging","title":"ATNA Logging","text":"<p>OpenHIM supports the Audit Trail and Node Authentication (ATNA) Integration Profile, which establishes a standard for responsibly storing audit events. It is highly recommended that the OpenHIM be configured as such but only after it is ensured that all default passwords have been changed and the OpenHIM is operating on a local subnet and thus not exposed externally. See the above hardening notes.</p> <p>See the OpenHIM user guide for information on ATNA configuration.</p>"},{"location":"admin/security/#non-production","title":"Non-Production","text":"<p>In non-production settings only may self-signed certificates be created for testing and demonstrations. An example is as follows:</p> <pre><code>openssl req -newkey rsa:4096 -keyout dhis2_key.pem -out dhis2_csr.pem -nodes -days 365 -subj \"/CN=dhis2\"\nopenssl x509 -req -in dhis2_csr.pem -CA ../certificates/server_cert.pem -CAkey ../certificates/server_key.pem -out dhis2_cert.pem -set_serial 01 -days 36500\nopenssl pkcs12 -export -in dhis2_cert.pem -inkey dhis2_key.pem -out dhis2.p12\n</code></pre>"},{"location":"admin/troubleshooting/","title":"Troubleshooting","text":""},{"location":"dev/addalgos/","title":"Add Algorithms","text":"<p>25 types and variations of the most common algorithms are supported by OpenCR, including those through the OpenSearch/ElasticSearch plugins:</p> <p>For OpenSearch users:</p> <p>analysis-phonetic and string-similarity</p> <p>ElasticSearch users:</p> <p>analysis-phonetic and string-similarity</p> <p>If more are required or revisions needed, the recommended approach is to:</p> <ul> <li>Write and test the primary algorithm code as an ElasticSearch plugin. This ensures performance, usage in the broader ElasticSearch community, and a platform to test for accuracy.</li> <li>Add hooks into the OpenCR Service to support the algorithm.</li> <li>Add a decision rules template to show how to use the plugin for end users.</li> <li>Determine if the plugin is required. If so, see the code in this config</li> </ul>"},{"location":"dev/contributing/","title":"Contributing","text":"<p>There may be many areas of potential contribution as OpenCR is not one application, it's several and can be more than that in your use case.</p> <p>It's recommended that you identify the specific feature or use case that needs support and </p> <p>For a quick question, reach out on the iHRIS Slack team. Sign up here</p> <p>For a bug or feature, reach out to the relevant repository to share the information. See the developer page for links to the different applications.</p> <p>For a broader discussion with others interested and with a background in Client Registry implementation science, please join the OpenHIE Client Registry Community calls and get involved.</p>"},{"location":"dev/docs/","title":"Building Documentation","text":"<p>This documentation is built using MkDocs and the Material for MkDocs theme.</p> <p>PDF export is done using mkdocs-pdf-export-plugin. All configuration information is in mkdocs.yaml in the repository. Note that at some future time the docs may be migrated into the main client registry repository.</p> <p>Edits to docs are made in the master branch of the client registry repository docs repo. </p> <p>After docs are edited, they are pushed to origin master, and then the <code>mkdocs gh-deploy</code> is run on the command line. This pushes into the gh-pages branch on GitHub. Only master is ever edited. The gh-pages is only modified by the CLI. </p>"},{"location":"dev/license/","title":"License","text":""},{"location":"dev/license/#license","title":"License","text":""},{"location":"dev/license/#cr-service","title":"CR Service","text":"<p>The CR Service is under a permissive license.</p>"},{"location":"dev/license/#hapi-fhir-server","title":"HAPI FHIR Server","text":"<p>HAPI is licensed under the Apache 2.0 license. See: https://hapifhir.io/hapi-fhir/license.html.</p>"},{"location":"dev/license/#elasticsearch","title":"ElasticSearch","text":"<p>ElasticSearch is Apache 2.0 and primarily supported by Elastic.co who offer open and open plus proprietary releases and a stack of apps based on ElasticSearch (like the Kibana dashboarding platform). </p> <p>This CR implementation only uses core, open features, not enterprise features. Netflix and Amazon Web Services also have a distribution of ElasticSearch that is 100% open source and that they have added open source enterprise features to like authentication. Developers who want to test other distributions and features of ElasticSearch are welcome to do so and encouraged to share their experiences with the maintainers.</p> <p>Open Distro for ElasticSearch</p>"},{"location":"dev/roadmap/","title":"Roadmap","text":"<p>The maintainers seek feedback from the broader health IT community involved in patient identity management to inform future directions for OpenCR. Please reach out on the OpenCR channel on the iHRIS Slack!</p> <p>Priority areas for feedback are the following:</p> <ul> <li> <p>Simplify configuration for patient matching decision rules: A longstanding request is to simplify configuration for patient matching decision rules. In 2022 this was addressed by removing the need to write a configuration for ElasticSearch for decision rules. Instead, fields required for indexing because they are in the decision rules are automatically included for indexing.</p> </li> <li> <p>Support for HAPI FHIR Server MDM (Master Data Management) as an optional deduplication service: This feature would make it possible to use OpenCR with the HAPI MDM and allow implementers to either choose elasticsearch/opensearch or HAPI MDM for deduplication. OpenCR utilizes ElasticSearch/OpenSearch for the task of matching which is scalable and fast. After the initial release of OpenCR, SmileCDR released a patient identity matching mechanism and then overhauled it to allow matching any FHIR resources. There are proprietary features in the SmileCDR product that allow managing 'golden records', meaning to promote fields as authoritative. OpenCR has an open source UI which does not exist in the HAPI or SmileCDR products.</p> </li> <li> <p>Support Keycloak and similar: This feature would allow for using authentication and authorization realms managed by Keycloak, a popular open source engine. The point in here is to enhance authentication in opencr which currently it only do basic authentication</p> </li> <li> <p>Support for deduplication without submitting a patient: Currently opencr runs the deduplication service every time a new patient is submitted or an existing patient is updated. This feature will allow openCR to be run without waiting for patient submission, especially when decision rules are changed.</p> </li> <li> <p>Make openCR easily customizable: The plan is to use iHRIS technology.</p> </li> </ul>"},{"location":"impl/roles/","title":"Roles and Responsibilities","text":""},{"location":"impl/roles/#responsibilities","title":"Responsibilities","text":"<p>There are a great deal of responsibilities that must be addresses for a successful implementation beyond the OpenHIE Implementation Guide.</p> <ul> <li>Which systems will connect to the CR and how will support for querying the CR be implemented on the POS side? There is emerging FHIR support for POS systems but features will need to be added to submit and process the queries. The Developer Guide includes a link to a reference implementation for OpenMRS MPI Client.</li> <li>Which form fields of demographic data will be submitted? Every use case and every form is different. There may be many different sets of demographic data that are stored, and this affects how matching is done.</li> <li>Which algorithms and decision rules make sense for the use case? There is a scientific literature on which algorithms perform efficiently for matching. There is a need to test algorithms -- which can be done outside of the CR such as in R and Python -- and the need to evaluate against what the CR implementation is doing to ensure consistency.</li> <li>How will the matching algorithms be implemented, deployed, and backed-out for incorrect matches? The CR includes an Admin UI for matching. The UI is meant to be highly restricted; it makes available demographic records. </li> <li>Who is responsible for providing preprocessed data to the CR? The CR accepts formatted FHIR messages. It does not impose its own algorithms for cleaning. Connecting POS systems must provide data in the correct format and preprocess the data before sending. Updates can be made to incorrect demographic data later and those will be added to existing records.</li> <li>How will systems launch and scaling up be managed? What network and compute resources are available for deployment. Advanced Linux systems administration skills are required to launch and maintain the CR in production.</li> </ul>"},{"location":"impl/roles/#roles","title":"Roles","text":"<p>In actual practice, there are specific roles.</p> <ul> <li>Point-of-service systems users: POS systems use the Client Registry to obtain a CRUID. This process is mostly invisible. Users of EMRs and other systems submitting queries may only see that there is a CRUID for a patient. The Client Registry is invisible to them.</li> <li>POS developers: Client Registry integration must be added into POS systems for them to be able to query for a CRUID. Software developers of POS systems should review the Developer Manual and understand how to implement the proper FHIR query for obtaining a CRUID.</li> <li>Matching administrators There may be situations in which the Client Registry implementation uses the UI for viewing and breaking matches. This is a privileged role that should be restricted to few individuals.</li> <li>Client Registry systems administrator: People managing the network, servers, backups and other aspects of the Client Registry. They should be very familiar with the Developer Guide, particularly security of the system, how to perform upgrades, and recovery procedures</li> <li>Management team: Governance of the system should be handled by a management team familiar with the implications of decisions, strategy, roll-out, and other aspects.</li> </ul>"},{"location":"notebooks/basic_query_in_python/","title":"Basic query in python","text":"<pre><code>#!/usr/bin/env python3\nfrom pathlib import Path\n# import requests\nfrom requests_pkcs12 import get, post\n</code></pre> <pre><code># path to your git clone of github.com/intrahealth/client-registry\ncrhome = Path.home() / 'src' / 'github.com' / 'intrahealth' / 'client-registry'\nclientcert = crhome / 'server' / 'sampleclientcertificates' / 'openmrs.p12'\nservercert = crhome / 'server' / 'certificates' / 'server_cert.pem'\ncsv_file = crhome / 'tests' / 'uganda_data_v21_20201501.csv'\npayload_bytes = crhome / 'DemoData' / 'patient1_openmrs.json'\npayload = open(payload_bytes)\n</code></pre> <pre><code>server = 'https://localhost:3000/Patient'\nheaders = {'Content-Type': 'application/json'}\nresponse = post(server, headers=headers, data=payload, \n                pkcs12_filename=clientcert, \n                pkcs12_password='', \n                verify=servercert)\n</code></pre> <pre>\n<code>/usr/local/lib/python3.7/site-packages/urllib3/connection.py:394: SubjectAltNameWarning: Certificate for localhost has no `subjectAltName`, falling back to check for a `commonName` for now. This feature is being removed by major browsers and deprecated by RFC 2818. (See https://github.com/urllib3/urllib3/issues/497 for details.)\n  SubjectAltNameWarning,\n</code>\n</pre> <pre><code>print(response.headers['location'])\n</code></pre> <pre>\n<code>Patient/d240c89e-b34f-4394-95a6-05fe11654998\n</code>\n</pre> <pre><code>\n</code></pre>"},{"location":"notebooks/basic_query_in_python/#duplicate-a-simple-curl-query-in-python","title":"Duplicate a simple cURL query in Python.","text":"<p>This example is available in the Jupyter notebook at: github.com/intrahealth/client-registry-docs/notebooks/simple_query_in_python.ipynb</p> <pre><code>curl --cert sampleclientcertificates/openmrs.p12 --cert-type p12 --cacert certificates/server_cert.pem -d @/Users/richard/src/github.com/openhie/client-registry/DemoData/patient1_openmrs.json -H \"Content-Type: application/json\" -XPOST https://localhost:3000/Patient\n</code></pre>"},{"location":"notebooks/load_bulk_data_in_python/","title":"Load bulk data in python","text":"<pre><code>#!/usr/bin/env python3\nfrom pathlib import Path\nfrom requests_pkcs12 import get, post\nimport pandas as pd\nimport numpy as np\n\nimport recordlinkage\n\nimport fhirclient.models.patient as p\nimport fhirclient.models.humanname as hn\nimport fhirclient.models.contactpoint as cp\nimport fhirclient.models.fhirdate as fd\nimport fhirclient.models.identifier as ident\nfrom fhirclient import client\n\nimport json\nimport time\nimport itertools\n\n# suppress warning: \"Certificate for localhost has no `subjectAltName`, falling back to check for a `commonName` for now\"\nimport urllib3\nurllib3.disable_warnings(urllib3.exceptions.SubjectAltNameWarning)\n</code></pre> <pre><code># versions\nprint(\"Pandas version: {0}\".format(pd.__version__),'\\n')\nprint(\"Python Record Linkage version: {0}\".format(recordlinkage._version.get_versions()['version']),'\\n')\nprint(\"Numpy version: {0}\".format(np.__version__),'\\n')\nprint(\"FHIR client version: {0}\".format(client.__version__),'\\n')\n</code></pre> <pre>\n<code>Pandas version: 1.0.3 \n\nPython Record Linkage version: 0.14 \n\nNumpy version: 1.18.4 \n\nFHIR client version: 3.2.0 \n\n</code>\n</pre> <pre><code># path to your git clone of github.com/intrahealth/client-registry\ncrhome = Path.home() / 'src' / 'github.com' / 'intrahealth' / 'client-registry'\nclientcert = crhome / 'server' / 'sampleclientcertificates' / 'openmrs.p12'\nservercert = crhome / 'server' / 'certificates' / 'server_cert.pem'\ncsv_file = crhome / 'tests' / 'uganda_data_v21_20201501.csv'\n</code></pre> <pre><code>df_a = pd.read_csv(csv_file)\n# df_a = df_a.set_index('rec_id')\nprint('Number of records :', len(df_a))\nprint(df_a.head())\n</code></pre> <pre>\n<code>Number of records : 5000\n         rec_id sex date_of_birth given_name       surname phone_number  \\\n0  rec-2762-org   f      19671207     zuwena         acile   712 300633   \n1  rec-2009-org   f      19761028     zuwena        lusike   772 614594   \n2  rec-3269-org   f      19811002     zuwena      mungugeo   772 162632   \n3  rec-1609-org   f      19270719    zuraika   akantambira   772 837692   \n4  rec-2802-org   m                   zulfas      nyanchwo   782 855101   \n\n       uganda_nin   art_number  \n0  CF21927470OWMT   KMC-819708  \n1  CF68167355NUZY   KUB-176148  \n2  CF50136842UQFQ   MBA-746695  \n3  CF68008770HZML   KMC-270901  \n4  CM25736526XWGC   KSG-830566  \n</code>\n</pre> <pre><code># some cleaning\ndf_a['rec_id'] = df_a['rec_id'].str.strip()\ndf_a['sex'] = df_a['sex'].str.strip()\ndf_a['given_name'] = df_a['given_name'].str.strip()\ndf_a['surname'] = df_a['surname'].str.strip()\ndf_a['date_of_birth'] = df_a['date_of_birth'].str.strip()\ndf_a['phone_number'] = df_a['phone_number'].str.strip()\ndf_a['uganda_nin'] = df_a['uganda_nin'].str.strip()\ndf_a['art_number'] = df_a['art_number'].str.strip()\n\ndf_a['sex']= df_a['sex'].replace('f', 'female')\ndf_a['sex']= df_a['sex'].replace('m', 'male')\nprint(df_a['sex'].value_counts())\n\n# fhirclient validates and some birthdate fields are empty/improperly formatted\n# remove non-digits\ndf_a['date_of_birth'] = df_a['date_of_birth'].str.extract('(\\d+)', expand=False)\n# force into datetime (coerce has benefit that it removes anything outside of 8 digits)\ndf_a['date_of_birth'] =  pd.to_datetime(df_a['date_of_birth'], errors='coerce')\n# now back into str or fhirdate will complain\ndf_a['date_of_birth'] = df_a['date_of_birth'].apply(lambda x: x.strftime('%Y-%m-%d')if not pd.isnull(x) else '')\n\nprint(df_a.head())\n</code></pre> <pre>\n<code>female    3224\n           963\nmale       809\nd            1\nr            1\nq            1\nk            1\nName: sex, dtype: int64\n         rec_id     sex date_of_birth given_name      surname phone_number  \\\n0  rec-2762-org  female    1967-12-07     zuwena        acile   712 300633   \n1  rec-2009-org  female    1976-10-28     zuwena       lusike   772 614594   \n2  rec-3269-org  female    1981-10-02     zuwena     mungugeo   772 162632   \n3  rec-1609-org  female    1927-07-19    zuraika  akantambira   772 837692   \n4  rec-2802-org    male                   zulfas     nyanchwo   782 855101   \n\n       uganda_nin  art_number  \n0  CF21927470OWMT  KMC-819708  \n1  CF68167355NUZY  KUB-176148  \n2  CF50136842UQFQ  MBA-746695  \n3  CF68008770HZML  KMC-270901  \n4  CM25736526XWGC  KSG-830566  \n</code>\n</pre> <pre><code># default server/path\nserver = \"https://localhost:3000/Patient\"\n# 3 records, modify if more are required\nlimit = 100\nfor index, row in itertools.islice(df_a.iterrows(), limit):\n# for index, row in df_a.iterrows():\n    patient = p.Patient() # not using rec_id as pandas id, leaving empty\n    patient.gender = row['sex']\n    name = hn.HumanName()\n    name.given = [row['given_name']]\n    name.family = row['surname']\n    name.use = 'official'\n    patient.name = [name]\n    phone = cp.ContactPoint()\n    phone.system = 'phone'\n    phone.value = row['phone_number']\n    patient.telecom = [phone]\n    patient.birthDate = fd.FHIRDate(row['date_of_birth'])\n    emr = ident.Identifier()\n    emr.system = 'http://clientregistry.org/openmrs'\n    emr.value = row['rec_id']\n    art = ident.Identifier()\n    art.system = 'http://system1/artnumber'\n    art.value = row['art_number']\n    nin = ident.Identifier()\n    nin.system = 'http://system1/nationalid'\n    nin.value = row['uganda_nin']\n    patient.identifier = [emr, art, nin]\n    # print(json.dumps(patient.as_json()))\n\n    headers = {'Content-Type': 'application/json'}\n    start = time.time()\n    response = post(server, headers=headers, data=json.dumps(patient.as_json()), \n                    pkcs12_filename=clientcert, pkcs12_password='', verify=servercert)\n    end = time.time()\n    print(index, response.headers['location'], \" | \", round((end - start), 1), \"ms\") # response.headers['Date']\n    # print(response.headers)\n</code></pre> <pre>\n<code>0 Patient/998bd085-8cac-4d80-a2dc-35dafad28140  |  2.1 ms\n1 Patient/7e5bfabb-c77d-403d-b583-14f9c04bcc4f  |  1.6 ms\n2 Patient/72a4ad32-4955-4ffc-9b6f-2ba849abcbcf  |  1.8 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>3 Patient/f372452d-d4e5-494d-b87b-da546e2908d7  |  1.3 ms\n4 Patient/7c743b88-04f0-4638-b12c-cb45a7604234  |  1.4 ms\n5 Patient/6299bc99-a6cf-4a37-8f31-08d7c954bcb6  |  1.5 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>6 Patient/b21337a7-72d2-43a7-8c4b-5c6ddc61e853  |  1.2 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>7 Patient/817c50fd-55fb-4bad-88ae-cfa32150cd72  |  1.4 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>8 Patient/ff310860-450d-49ac-9754-c4b52800258c  |  1.2 ms\n9 Patient/f21900bc-b0ac-4145-bfe5-5d2d111ac34c  |  1.0 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>10 Patient/2329cbf5-3bf5-44d2-87dd-a7b75dc083dd  |  1.3 ms\n11 Patient/b2f45d9a-be8a-4a98-ae0b-23bae838e2c9  |  1.1 ms\n12 Patient/4eec0f3b-39f0-43da-a68c-0f2c68b7c998  |  0.9 ms\n13 Patient/8fc2ab00-91dd-4b4b-81a8-25d7af976363  |  1.2 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>14 Patient/dfd9e992-92ba-4f80-839e-05e4f984a57d  |  1.0 ms\n15 Patient/c47e5989-166e-44fa-828c-837dfbd73789  |  1.0 ms\n16 Patient/cfe6500c-9ddf-466e-b14a-ba9f332ce53e  |  1.3 ms\n17 Patient/2e5ef1ad-4e46-4cd5-8af6-e4624e420a5b  |  1.1 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>18 Patient/3bc91e43-e4ae-4a7b-8b38-be31d98b5828  |  0.8 ms\n19 Patient/c18671b9-d986-4039-ab81-0a949b9a19a2  |  1.1 ms\n20 Patient/208a9966-94c0-4955-8d5c-11b7e22e7289  |  1.0 ms\n21 Patient/c21bc854-c1db-4ab3-a189-5d4459c5294e  |  0.8 ms\n22 Patient/dc255b83-ca8d-42c9-bc2d-3c6c5b9d0561  |  0.8 ms\n23 Patient/dc255b83-ca8d-42c9-bc2d-3c6c5b9d0561  |  1.0 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>24 Patient/85299742-df8a-4917-a16a-d466495b0a78  |  1.0 ms\n25 Patient/5411a1bd-2ed8-49e6-bdbf-305d36361cf6  |  1.1 ms\n26 Patient/def894a2-f86d-48da-9d1e-a37a0f88d55f  |  1.1 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>27 Patient/1844e0a4-8748-40dd-9914-603d5ef8a065  |  0.9 ms\n28 Patient/03ab3f55-c854-42dd-ac2f-458eedadc317  |  0.9 ms\n29 Patient/a7bc6c0c-b2a9-4a93-b445-246135c3457c  |  1.2 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>30 Patient/02312cad-0fcf-4af0-b256-0878bbbc8791  |  0.9 ms\n31 Patient/70540ad6-f642-4800-9bba-49fe2f723a4d  |  1.2 ms\n32 Patient/9507e691-b1c0-48a7-8997-197c40c4129a  |  1.0 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>33 Patient/0c816ae3-a880-4d9e-bbd9-265a6c5ac422  |  0.8 ms\n34 Patient/b5e969be-5e18-4316-b59d-3c43bd7fdf85  |  0.8 ms\n35 Patient/69901b11-cafc-4311-aa04-9c9a3c9654b7  |  1.1 ms\n36 Patient/4973cb93-3111-4d6e-9a10-ce2c6f36e4da  |  1.0 ms\n37 Patient/a5996f64-54a7-45a3-9c73-288809305413  |  0.8 ms\n38 Patient/731be98f-9cab-40cf-9897-e2a220d95eab  |  1.1 ms\n39 Patient/738b656d-1654-4341-893b-ce8743240974  |  0.9 ms\n40 Patient/478d11de-006e-43ce-aadc-b2a55e6f7e96  |  1.1 ms\n41 Patient/d88cb8fa-4055-4215-8f88-36a65ae41f87  |  0.9 ms\n42 Patient/44b448f1-6765-477d-b2f7-3556fb57fc7a  |  0.9 ms\n43 Patient/8e42ebd7-3037-4c1a-9bb3-278c70b2dde0  |  1.0 ms\n44 Patient/8c97acdb-ccd1-4ccd-a8c8-ed8f827d6dd7  |  1.2 ms\n45 Patient/b6c88343-822c-4443-91c1-0f45e5eb3906  |  0.7 ms\n46 Patient/cd88762c-e116-472d-b05e-8ba7d6d7c81c  |  0.9 ms\n47 Patient/11603220-0e66-4b0e-a5ff-a4635a91f16d  |  1.0 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>48 Patient/b3322a33-3374-486b-96b5-9a88883d4515  |  0.9 ms\n49 Patient/a16d8e5d-7304-4b3b-8462-548efc1faac4  |  1.1 ms\n50 Patient/92720ee1-2e2e-49c6-a971-1a9bcc669902  |  1.1 ms\n51 Patient/30c9d4e9-dd00-476e-beb0-4f4ba95f7cd9  |  0.9 ms\n52 Patient/92720ee1-2e2e-49c6-a971-1a9bcc669902  |  0.7 ms\n53 Patient/3f399446-e624-4e89-94ac-1f46e2a612c1  |  1.1 ms\n54 Patient/e4f323cd-3c01-4b5e-b612-a2bbe188d865  |  0.8 ms\n55 Patient/c23c89db-5660-4839-840b-eb0a77e2f49d  |  1.0 ms\n56 Patient/d2393b8d-ed7a-4eb9-b1ab-c70460146a4f  |  1.2 ms\n57 Patient/b6010023-5162-473c-a4e1-56e1b348087e  |  1.0 ms\n58 Patient/3843a23b-4ae7-4592-9b4a-a966e22d8fc9  |  0.9 ms\n59 Patient/7212d479-d306-4568-8013-e59ee8913dd7  |  1.1 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>60 Patient/6ff08c0c-d0fb-4eda-96ad-91ece4f207ca  |  0.8 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>61 Patient/f3f62e4d-1b4d-453d-9ea3-c66ce2ad1f20  |  0.9 ms\n62 Patient/e321c2dd-96e7-4c6d-ba36-6fa71b63ae0a  |  1.1 ms\n63 Patient/92b9eb21-0b30-4b49-b611-a3830c233612  |  0.9 ms\n64 Patient/92b9eb21-0b30-4b49-b611-a3830c233612  |  0.7 ms\n65 Patient/47318447-2d0a-473d-a31e-6cf92619a4e6  |  1.0 ms\n66 Patient/acd8f41e-3285-447d-a4d0-af6a440b329e  |  1.0 ms\n67 Patient/4b2414e5-177a-45dd-9820-e0208212b517  |  0.8 ms\n68 Patient/2f6365b6-861e-411e-b429-2d579ab5bd04  |  1.0 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>69 Patient/2f6365b6-861e-411e-b429-2d579ab5bd04  |  1.0 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>70 Patient/213c6b3d-5d13-4ad9-b6b4-ab2ceaee324a  |  0.8 ms\n71 Patient/3576d266-c676-43ea-9023-bb11c11b2b6b  |  0.9 ms\n72 Patient/59369ae7-a50f-4c88-8fa0-7cd30e317d7e  |  0.9 ms\n73 Patient/d78ca73d-e8ff-4bd6-a505-ef929161fda6  |  0.7 ms\n74 Patient/70277660-d1ec-4fe2-9853-50ad88cc5f7a  |  0.8 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>75 Patient/59369ae7-a50f-4c88-8fa0-7cd30e317d7e  |  0.7 ms\n76 Patient/70277660-d1ec-4fe2-9853-50ad88cc5f7a  |  1.2 ms\n77 Patient/1261bb98-582e-45cc-8a19-ec172c6c6f4f  |  1.3 ms\n78 Patient/9c912e01-5e34-471a-b6c1-b650cc6c2601  |  1.2 ms\n79 Patient/d6bc698f-6af2-4578-ad12-ba0bd9d14ed4  |  0.8 ms\n80 Patient/1261bb98-582e-45cc-8a19-ec172c6c6f4f  |  1.2 ms\n81 Patient/e5426498-f107-447c-ab01-b0b4008732aa  |  0.9 ms\n82 Patient/3f6ddd3e-f4fd-45f6-9c60-c16904d9f0aa  |  0.7 ms\n83 Patient/a933a54d-e34e-485e-9c95-6cb54f4f2533  |  1.5 ms\n84 Patient/609660b5-c1aa-409f-bd9a-cc3d7dac6384  |  1.2 ms\n85 Patient/c622e666-fdf6-4d61-a853-3e33d49e2d11  |  0.9 ms\n</code>\n</pre> <pre>\n<code>Failed to initialize FHIRDate from \"\": Unrecognised ISO 8601 date format: ''\n</code>\n</pre> <pre>\n<code>86 Patient/86b01ded-7acd-49d8-90e0-63e25662188a  |  1.1 ms\n87 Patient/6672ce4d-190a-4be0-9afa-11340b34f9c7  |  1.8 ms\n88 Patient/50f359c6-cb99-4a7e-a466-ec97b80225fc  |  0.8 ms\n89 Patient/2cf7014c-6a88-42d0-951f-f24375e9c249  |  0.9 ms\n90 Patient/f60e5b30-921d-4ca9-b5a8-c00574049ae3  |  1.0 ms\n91 Patient/b9e04ae8-0ca2-4c50-b122-5e57448e0d38  |  1.1 ms\n92 Patient/4bf4445a-8026-432f-a6ca-f9d277ff7d11  |  1.0 ms\n93 Patient/d34127e7-cc18-43df-b45b-12679c286d5d  |  0.8 ms\n94 Patient/4bf4445a-8026-432f-a6ca-f9d277ff7d11  |  1.2 ms\n95 Patient/a2ed2adf-bb3f-40e5-a05d-c99c89eb3ed5  |  0.9 ms\n96 Patient/7fbe823f-5a44-4ef8-9728-98e27f00d038  |  0.8 ms\n97 Patient/7506a352-2486-452d-be15-25a40838a48e  |  0.7 ms\n98 Patient/54309891-fa19-489e-bb0f-e95360bb7ee0  |  0.8 ms\n99 Patient/71e25c0b-1eb3-4739-9264-80e2971dc581  |  0.7 ms\n</code>\n</pre> <pre><code>\n</code></pre>"},{"location":"notebooks/load_bulk_data_in_python/#load-bulk-data-in-python","title":"Load bulk data in Python","text":"<p>This example is available in the Jupyter notebook at: github.com/intrahealth/client-registry-docs/docs/notebooks/load_bulk_data_in_python.ipynb</p>"},{"location":"user/algos/","title":"Intro to Algorithms","text":"<p>Algorithms can be deterministic, fuzzy, probabilistic, or a combination of approaches; most include some element of automatic matching plus human review. No perfect algorithm currently exists <sup>1</sup>. Typically, the creator(s) of the client registry will agree on the appropriate threshold to determine a \"match\" and this may need to be recalibrated over time.</p>"},{"location":"user/algos/#approaches","title":"Approaches","text":"<p>Types of matching approaches:</p> <ul> <li> <p>Deterministic. This can be thought of enforcing exact matches. This type of matching performs poorly when the quality of the data is low and/or the discriminatory power of the variable used for matching is low (e.g. sex is a poor discriminatory variable). If exact matching is enforced, the data scientist should verify that other fields also match using a combination of approaches, as needed.</p> </li> <li> <p>Fuzzy. The fuzzy match method relies on converting items to their core components (e.g. phonetics) to determine matching rather than relying on probabilities. This method\u2019s strength is addressing typing errors but remains imperfect in cases where words are similar, but are not the same (e.g. there, their). Its efficacy is unproven in most languages other than English.</p> </li> <li> <p>Probabilistic. This is a method that assigns a match probability to a pair of records. The most common method (Fellegi-Sunter) checks a number of fields and sums up the probabilities that each field is a match. Higher scores indicate a match. Recent research has been directed at improving the FS method <sup>2</sup>.</p> </li> </ul> <p>Matching algorithms are evaluated based on their sensitivity and specificity in detecting matches. One caveat to remember is to check whether the sensitivity and specificity reported are with or without human review. Generally, it is better to minimize the chances of a false positive; however, as false positives go towards zero false negatives increase and the balance must be maintained.</p>"},{"location":"user/algos/#types-of-deterministic-matching","title":"Types of Deterministic Matching","text":"<ul> <li>Field-based (exact) matching. Typically fields are compared to each other across data sets and a result is a match or non-match, thus deterministic.</li> </ul>"},{"location":"user/algos/#types-of-fuzzy-matching","title":"Types of Fuzzy Matching","text":"<p>Methods that assist in matching based on phonetic transformations to remedy spelling errors:</p> <ul> <li>Soundex indexes names by sound as pronounced in English. The Soundex encoding includes the first letter of a surname followed by 3 digits. This method relies on correctly recording the first letter of a name.</li> <li>Metaphone indexes words by their English pronunciation.</li> <li>Double Metaphone implements Metaphone but allows for two encodings to be returned for a word rather than constraining it to one choice. It works well with names of various origins, but the lettering must be English.</li> <li>Metaphone 3 is the next generation of Double Metaphone and is a commercial product. </li> </ul> <p>Methods that compare string similarity:</p> <ul> <li>Levenshtein edit distance is a measure of the number of edits (insertions and deletions) that would be required to change one string to another.</li> <li>Jaro-Winkler comparator/distance is similar to Levenshtein, but it gives more weight to strings that match on the beginning of the string. 0 is an exact match. Lower scores are better than higher scores. If the beginning of the string is misspelled, this will not work as well.</li> <li>Longest common subsequence matches subsequences within strings. Subsequences do not need to match positions.</li> </ul>"},{"location":"user/algos/#types-of-probabilistic-matching","title":"Types of Probabilistic Matching","text":"<p>The most widely used probabilistic matching method is the Fellegi-Sunter method <sup>3</sup>. In this method, each field is weighted by its discriminatory power and data quality; could be manually or via model training <sup>4</sup>. The algorithm checks each field and decides whether the field matches between the pairs or not. If the fields match, the weight is added to the final score. If the fields do not match, the weight is subtracted from the final score. If the sum of the weights is above a threshold, they are considered a match. Possible matches can also be produced and these would require human review.</p> <p>One drawback is that this method assumes that no fields are correlated with each other or that they are not conditionally dependent. The assumption of conditional independence does not always hold and can lead to suboptimal results which is the biggest limitation of this method <sup>5</sup>. For example, there are more women named Barbara than men named Barbara. First name and sex are not independent. </p> <p>Extensions to the F-S method include: </p> <ul> <li>The approximate comparator extension (ACE) <sup>6</sup> which includes string matching strategies prior to performing the weighting and scoring.</li> </ul> <p>Alternatives to F-S include (see video):</p> <ul> <li>GHC Scaling Algorithm <sup>7</sup> is an order of magnitude faster than F-S. Calculates underlying weights and doesn\u2019t rely on independence assumption.</li> </ul>"},{"location":"user/algos/#speed","title":"Speed","text":"<p>Methods to reduce the number of comparisons and speed up the process:</p> <ul> <li>Blocking. This is like sorting socks by color before trying to match them. It speeds up the process by reducing the number of pairs that need to be checked.</li> </ul> <ol> <li> <p>McFarlane, T. D., Dixon, B. E., &amp; Grannis, S. J. (2016). Client registries: identifying and linking patients. In Health Information Exchange (pp. 163-182). Academic Press.\u00a0\u21a9</p> </li> <li> <p>Li, X., Xu, H., Shen, C., &amp; Grannis, S. (2018). Automated linkage of patient records from disparate sources. Statistical methods in medical research, 27(1), 172-184. DuVall, Scott L., Richard A. Kerber, and Alun Thomas. \"Extending the Fellegi\u2013Sunter probabilistic record linkage method for approximate field comparators.\" Journal of biomedical informatics 43.1 (2010): 24-30.\u00a0\u21a9</p> </li> <li> <p>McFarlane, T. D., Dixon, B. E., &amp; Grannis, S. J. (2016). Client registries: identifying and linking patients. In Health Information Exchange (pp. 163-182). Academic Press.\u00a0\u21a9</p> </li> <li> <p>DuVall, Scott L., Richard A. Kerber, and Alun Thomas. \"Extending the Fellegi\u2013Sunter probabilistic record linkage method for approximate field comparators.\" Journal of biomedical informatics 43.1 (2010): 24-30.\u00a0\u21a9</p> </li> <li> <p>Li, X., Xu, H., Shen, C., &amp; Grannis, S. (2018). Automated linkage of patient records from disparate sources. Statistical methods in medical research, 27(1), 172-184.\u00a0\u21a9</p> </li> <li> <p>DuVall, Scott L., Richard A. Kerber, and Alun Thomas. \"Extending the Fellegi\u2013Sunter probabilistic record linkage method for approximate field comparators.\" Journal of biomedical informatics 43.1 (2010): 24-30.\u00a0\u21a9</p> </li> <li> <p>Goldstein, H., Harron, K., &amp; Cortina\u2010Borja, M. (2017). A scaling approach to record linkage. Statistics in medicine, 36(16), 2514-2521.\u00a0\u21a9</p> </li> </ol>"},{"location":"user/cruid/","title":"Unique Identifiers","text":"<p>OpenCR creates unique idenfiers (CRUIDs) which provide the key for record linkage.</p>"},{"location":"user/cruid/#example","title":"Example","text":"<p>In this example, there are three records for one person, Luke, and a CRUID has been assigned.</p> <ul> <li>Luke has records one EMR, another EMR, and a lab system.</li> <li>Each of his records has some demographic data.</li> <li>OpenCR has also created a CRUID - \"CRUID-1\", for Luke.</li> <li>There is a record for CRUID-1. It does not have demographic data, but it does have links to all of Luke's records.</li> <li>Once CRUID-1 has been assigned to Luke's records, his CRUID-1 is also linked to the original records.</li> </ul> <p></p>"},{"location":"user/guide/","title":"OpenHIE Implementation Guide","text":"<p>Implementation processes are complex. The OpenHIE Client Registry Subcommunity is a valuable resource for understanding the policies and practices of client registries, particularly in low resource settings. Visit their site.</p> <p>The community provides a comprehensive resource, The Client Registry Implementation Guide, may be consulted for the overall processes required to implement, including how to:</p> <ul> <li>Analyze the current environment</li> <li>Establish leadership and governance</li> <li>Document specifications and requirements</li> <li>Implement specifications</li> <li>Create a support plan</li> <li>Conduct a post-production evaluation</li> </ul>"},{"location":"user/introduction/","title":"Introduction","text":"<p>OpenCR is an open source and standards-based client registry. A client registry facilitates the exchange of patient information between disparate systems. A client registry holds patient identifers and may include patient demographic information. It is a necessary tool for public health to help manage patients, monitor outcomes, and conduct case-based surveillance.</p> <p>A client registry sits within a health information exchange (HIE). An HIE is used to safely and effectively exchange information. A critical component of an HIE are registries, such as those to manage a shared, canonical facility list, practitioners, and patients. </p>"},{"location":"user/introduction/#what-does-opencr-do","title":"What does OpenCR do?","text":"<p>OpenCR is offers the ability to:</p> <ul> <li>Assign and look-up unique identifiers,</li> <li>Allow connections from diverse point of service (POS) systems, such as electronic medical record (EMR) systems, that can submit messages in FHIR, and</li> <li>Configure decision rules around patient matching.</li> </ul> <p>Caution</p> <p>This implementation does not allow point-of-service systems to get patient demographic information stored in the Client Registry. This is also not a Shared Health Record, nor does it contain patient clinical data.</p> <p>The process for a point-of-service system like an EMR to get a unique ID from the Client Registry is straightforward though it looks complicated at first.</p> <ol> <li>A POS provides some demographic information to the Client Registry.</li> <li>The Client Registry looks for an existing record matching that patient.</li> <li>If there is an existing record, the Client Registry provides the unique ID back to the POS.</li> <li>If there is not an existing record, the Client Registry makes a new one and provides a unique ID back to the POS.</li> </ol> <p>As noted in the introduction, the Client Registry provides a unique identifier that also links to all other already matched records from submitting systems. This means that the Client Registry stores an identifier from submitting systems so that it can uniquely identify according to however the submitting systems store their records, but it also produces a UID for the entire domain using the service.</p> <p>Warning</p> <p>The below workflows the Client Registry does not store or provide clinical data. Such processes are external to the Client Registry and must be separately created, governed, and enabled. </p>"},{"location":"user/openmrs/","title":"OpenMRS MPI Client","text":""},{"location":"user/openmrs/#demo","title":"Demo","text":"<p>This demo shows how a patient is registered in OpenMRS with the MPI module (see below) and how that patient shows up in OpenCR where matches can be viewed and broken.</p>  Your browser does not support the video tag."},{"location":"user/openmrs/#installing-the-module","title":"Installing the Module","text":"<p>OpenCR can be setup to work with OpenMRS with the MPI module. There is a reference implementation for 2.x and legacy OpenMRS to connect to the CR. The branch must be chosen correctly.</p> <ul> <li>2.x support</li> <li>Legacy support</li> </ul>"},{"location":"user/process/","title":"Matching Process","text":"<p>This is an overview of the matching process.</p>"},{"location":"user/process/#generic-matching-process","title":"Generic Matching Process","text":"<p>It is helpful to look at a generic matching process first, and then move to to see where OpenCR fits.</p> <p>This diagram is reproduced from Christen, Peter, 2012, \"Data Matching: Concepts and Techniques for Record Linkage, Entity Resolution, and Duplicate Detection\"</p> <p>The diagram is an example of a deduplication process with only one data source.</p> <ul> <li>Database: The flow begins on the top left at 'Database'.</li> <li>Preprocessing: Data from the database source is preprocessed. This means cleaning the data before submission of errors in date formats, data entry mistakes, biologically implausible values, and similar.</li> <li>Blocking: This means using filters to be more efficient in queries. For example, filtering on the birth year of 1960 reduces the amount of searching that has to be done because only 1960 is used.</li> <li>Comparison: Algorithms compare pairs of records.</li> <li>Classification: Records are classified as matches, non-matches, or potential matches.</li> <li>Clerical review: For records that are potential matches, they may be reviewed individually.</li> <li>Evaluation: This process is a way to understand the matching performance against a known baseline. It is not necessarily built into the client registry but may be conducted using other tools.</li> </ul> <p></p> <p>OpenCR performs much of the functionality in the matching process.</p> <ul> <li>Database and preprocessing: The database and cleaning of records is done outside of OpenCR.</li> <li>Comparison and classification: In production, either Opensearch or ElasticSearch can be used for these processes. However we dont recommend elasticsearch only because of license restrictions it has.</li> <li>Clerical review: There is a UI for viewing and breaking matches.</li> <li>Evaluation: This process is conducted externally with other tools, it is not provided as a feature set in OpenCR.</li> </ul> <p></p>"},{"location":"user/recordlinkage/","title":"Record Linkage Process","text":"<p>The below diagram shows how OpenCR performs record linkage after the matching process. The diagram begins with a source system submitting a request with patient demographic data in a FHIR message, as indicated by the circle on the left.</p> <p></p> <p>After requests are submitted with demographic data, OpenCR reads the submitting system's ID of that patient. The Client Registry searches for that source system's ID in its records. This happens regardless if it is a new patient or update of existing patient.</p> <p>When the submitting system's ID matches an existing record, the Client Registry updates the patient demographic information of that record with changes submitted. Once the update is complete, the existing record linkages may affected. This is because algorithms may not continue to link records as before because details have changed. Therefore, the Client Registry will pool all patients that were previously matched and break all the matches. The Client Registry will rerun matching algorithms again to see what matches are currently true matches of the patient. Then the Client Registry will be updated with the true matches given the changes in demographic data.</p> <p>Another scenario is when the Client Registry searches and doesn't find anyone already with same submitting system's ID. If there is not existing match, the Client Registry runs the matching algorithms for existing patients who matches that patient and will provide record linkages with other records.</p>"},{"location":"user/recordlinkage/#requirements","title":"Requirements","text":"<p>In order for this process to work as expected, there are some requirements:</p> <ul> <li>Requests sent to the Client Registry must be made of FHIR messages. FHIR is a popular specification for accessing an API for providing data in health systems. Messages must support FHIR R4.</li> <li>Requests can only be received from trusted systems. See the security page in the Sysadmin Manual for mode detail.</li> </ul>"},{"location":"user/resources/","title":"Additional Resources","text":""},{"location":"user/supported/","title":"Supported Algorithms","text":"<p>A number of algorithms are supported using Opensearch/ElasticSearch with the analysis-phonetic plugin and the OpenCR Service (alone).</p> Algorithm OpenCR Service OpenSearch/ElasticSearch Exact Yes Yes Metaphone Yes Yes Double-metaphone Yes Yes Levenshtein Yes Yes Damerau-Levenshtein Yes Yes Jaro-Winkler Yes No Soundex Yes Yes <p>For more advanced string similarity matching, the similarity-scoring plugin for ElasticSearch can provide more features, and is based on the https://github.com/tdebatty/java-string-similarity library. The library is open source.</p> <p>For more information, see the similarity-scoring repository for OpenSearch or similarity-scoring repository for elasticsearch:</p> Matcher Parameter for Query Algorithm Type Normalized? cosine-similarity Cosine similarity yes dice-similarity Sorensen-Dice similarity yes jaccard-similarity Jaccard similarity yes jaro-winkler-similarity Jaro-Winkler similarity yes normalized-lcs-similarity Normalized Longest Common Subsequence similarity yes normalized-levenshtein-similarity Normalized Levenshtein similarity yes cosine-distance Cosine distance yes damerau-levenshtein Damerau-Levenshtein distance no dice-distance Sorensen-Dice distance yes jaccard-distance Jaccard distance yes jaro-winkler-distance Jaro-Winkler distance yes levenshtein Levenshtein distance no longest-common-subsequence Longest Common Subsequence distance no metric-lcs Metric Longest Common Subsequence distance yes ngram N-Gram distance yes normalized-lcs-distance Normalized Longest Common Subsequence distance yes normalized-levenshtein-distance Normalized Levenshtein distance yes optimal-string-alignment Optimal String Alignment distance no qgram Q-Gram distance no"},{"location":"user/ui-advanced/","title":"UI -- Human Adjudication","text":"<p>Caution</p> <p>You may not have access to the UI, and that's a good thing. The UI allows users to be able to view any break any match, which includes viewing demographic data from submitting systems. It should be secure and only authorized users must be able to access it.</p> <p>The OpenCR User Interface has advanced features for human adjudication to conduct curate matches and create new ones. This is more advanced than simply breaking and reverting matches.</p>"},{"location":"user/ui-advanced/#action-required-tab","title":"Action Required Tab","text":"<p>The home page has an action required tab. On this tab are a list of the flagged records. They may have one of two potential areas of human adjudication.</p> <ol> <li>Potential matches: These are matches which passed a minimum threshhold but another match was higher.</li> <li>Conflicts on match: These matches passed a high threshhold and are very close to the chosen match.</li> <li>Remove the flag: This is to remove the action required flag and no action will be taken.</li> </ol> <p></p> <p>In a column on the right are the reasons for action being required.</p> <p>Clicking on a record gives you only one set of actions for that record and its related record. Once that record is resolved in some way, through actions 1-3 above, then the next set of records will be loaded. Another way to get to a specific record is to search for it from the main actions required tab.</p>"},{"location":"user/ui-advanced/#understanding-the-actions-tab","title":"Understanding the Actions Tab","text":"<p>The actions page for the set of records shows large dark blue banners under which are each unique linked record in the set. The CRID (unique identifer in OpenCR) assigned is displayed along with more information.</p> <p></p>"},{"location":"user/ui-advanced/#options-menu","title":"Options Menu","text":"<p>There is an options menu to the right side. This has several faetures.</p> <p></p> <p>Save changes: After making all changes, the user must review and accept them. This feature can also be used to remove the flag and move to the next set of records.</p> <p></p> <p>Simplified naming: The simplified naming option is meant to make the records easier to reference. It uses the names of the elements in the periodic table. The names are only shortcuts to refer to the records instead of the identifiers. On another page the simplified names will be reused, so they are not unique between pages of records, only for each action page for groups of records. This feature can be turned off. The names do not in any reflect matching.</p> <p></p> <p>Show scores matrix: This shows a 2D matrix of all records against one another to show what the overall decision rules scores were that were the result of matching. When this is selected, a table pops up at the bottom of the page showing the matrix.</p> <p></p> <p>Include actual CRID with temporary ID: This toggles showing full IDs for the record.</p> <p></p>"},{"location":"user/ui-advanced/#views","title":"Views","text":"<p>Full view: On each subrecord under the CRID record there is a full view toggle. At the bottom of the page a popup card will show the full record information. This may be helpful in comparing records. If multiple toggles are flipped, then those records will all be revealed.</p> <p></p>"},{"location":"user/ui-advanced/#adjudication","title":"Adjudication","text":"<p>After review, in order to move records around into another CRID there is a dropdown menu. This makes it easy to select which records to move. If the record does not exist, then a new CRID can be created.</p> <p></p> <p>On selecting an action, there is a confirmation box. Note that the changes are not yet pushed.</p> <p></p>"},{"location":"user/ui-advanced/#review-changes-or-removing-flags","title":"Review Changes or Removing Flags","text":"<p>After making changes to records, the user must review and accept them.</p> <p></p> <p>Warning</p> <p>The user must choose to save changes in the option menu for changes to be made.</p>"},{"location":"user/ui/","title":"UI -- Basics","text":"<p>Caution</p> <p>You may not have access to the UI, and that's a good thing. The UI allows users to be able to view any break any match, which includes viewing demographic data from submitting systems. It should be secure and only authorized users must be able to access it.</p> <p>The OpenCR User Interface is a key way to monitor the operation of OpenCR. With it, you can:</p> <ul> <li>Verify FHIR messages are being processed correctly from submitting systems</li> <li>Validate matching is working as expected</li> <li>Perform deep inspection before putting it into production</li> <li>View matches, break matches, revert broken matches</li> <li>Conduct human adjudication to correct matches and create new ones.</li> </ul>"},{"location":"user/ui/#login","title":"Login","text":"<p>User must be added to the CRUX to be able to login.</p> <p></p>"},{"location":"user/ui/#landing-page","title":"Landing Page","text":"<p>On landing inside CRUX, it display the records submitted in a row. These are individual records for POS that submit them.</p> <p></p> <p>It is easy to search for records.</p> <p></p> <p>In the below example, there are two records submitted that share the same CRUID.</p> <p></p> <p>Searches can be restricted to specific points-of-service:</p> <p></p>"},{"location":"user/ui/#record","title":"Record","text":"<p>On clicking on an single record, a great deal of information is revealed.</p> <ul> <li>On the top right: All of the fields stored in the system</li> <li>On the top left: Matched records to the current one being viewed.</li> <li>Middle of the page: Broken matches, if they exist for the record.</li> <li>Bottom of the page: A history of all events affected the record, including creation, modification, and the decision rules used to make the matches.</li> </ul> <p></p>"},{"location":"user/ui/#matched-records-and-break-match","title":"Matched Records and Break Match","text":"<p>Matched records are listed in a compact table with links to other record.</p> <p>There is also an option to break one or all matches.</p> <p></p>"},{"location":"user/ui/#break-and-revert-matches","title":"Break and Revert Matches","text":"<p>A match can be broken. When a match is broken, the patient record is no longer linked to it, therefore its CRUID changes.</p> <p>Once a match is broken, it may be reverted, meaning that the match can be reinstated.</p> <p></p>"},{"location":"user/ui/#history","title":"History","text":"<p>The history card shows the set of decision rules and overall submission information about each history event. All events include any decision rules that were used to make those matches and the specific Opensearch/ElasticSearch query.</p> <p></p> <p>Decision rules include the overall rule to evaluate the chain of decision rules, which is either probabilistic or deterministic. Then the card shows each decision rule and its configuration. This card helps understand how a decision was made and is critical for evaluation purposes.</p> <p></p> <p>The history card also includes when the event occurred, the status, and the IP address of the submitting system. (The address 127.0.0.1 in the example means within the same computer, not from the network, and is for example purposes only.)</p> <p></p>"},{"location":"user/ui/#add-user","title":"Add User","text":"<p>There is a simple add user feature in the main menu for administrators.</p> <p></p>"},{"location":"user/usecases/","title":"Use Cases","text":"<p>At its core, OpenCR provides a unique identifier (UID) that also links to all other already matched records from submitting systems. This means that OpenCR stores an identifier from submitting systems so that it can uniquely identify according to however the submitting systems store their records, but it also produces a UID for the entire domain using the service.</p> <p>Several workflows are supported out-of-the-box depending on the POS-OpenCR use case. For example:</p> <ul> <li> <p>A specimen is received by a laboratory. Demographic data and requesting location data is entered into the LMIS. The LMIS queries OpenCR for a UID. OpenCR provides the UID if one did not exist and stores limited patient demographic information but does not store test results. A use that this enables (but OpenCR does not provide) is the ability to track persons lab results over time.</p> </li> <li> <p>A patient is registered at a clinic. The clinician recommends a viral load test. The specimen is sent for processing to the laboratory. OpenCR receives the UID and specimen and returns a diagnostic result that is then stored in the EMR. </p> </li> <li> <p>A patient is registered at a clinic and has been assigned a UID. In the course of their clinical encounter, a sentinel event occurs, triggering the EMR to send limited clinical information to the Health Information Exchange (HIE). The HIE sends the data to a data analysis warehouse for population analysis and case-based surveillance.</p> </li> </ul> <p>Warning</p> <p>It is important to note that in the above workflows OpenCR does not store or provide clinical data. Such processes are external to OpenCR and must be separately created, governed, and enabled. </p>"},{"location":"user/usecases/#viral-load-test-request-paper","title":"Viral Load Test Request (Paper)","text":"<p>A plasma specimen is received by a laboratory for HIV viral load testing. Demographic data and requesting location data is entered into the LMIS. The LMIS queries OpenCR for a UID. OpenCR provides the UID if one did not exist and stores limited patient demographic information but does not store test results. A use that this enables (but OpenCR does not provide) is the ability to track persons lab results over time.</p>"},{"location":"user/usecases/#viral-load-test-request-emr","title":"Viral Load Test Request (EMR)","text":"<p>A patient is registered at a clinic. The clinician recommends an HIV viral load test. The plasma specimen is sent for processing to the laboratory. OpenCR receives the UID and specimen and returns a diagnostic result that is then stored in the EMR. </p>"},{"location":"user/usecases/#case-based-surveillance","title":"Case-Based Surveillance","text":"<p>A patient is registered at a clinic and has been assigned a UID. In the course of their clinical encounter, a sentinel event occurs, triggering the EMR to send limited clinical information to the Health Information Exchange (HIE). The HIE sends the data to a data analysis warehouse for population analysis and case-based surveillance.</p>"}]}